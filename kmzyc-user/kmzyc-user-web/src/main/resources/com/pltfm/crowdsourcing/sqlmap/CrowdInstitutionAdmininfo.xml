<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CrowdInstitutionAdmininfo">
	<resultMap id="ibatorgenerated_BaseResultMap" class="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Mar 14 11:27:55 
			CST 2016. -->
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="loginId" property="loginId" jdbcType="DECIMAL" />
		<result column="INSTITUTION_CODE" property="institutionCode"
			jdbcType="VARCHAR" />
		<result column="REMARK1" property="remark1" jdbcType="VARCHAR" />
		<result column="REMARK2" property="remark2" jdbcType="VARCHAR" />
	</resultMap>


	<select id="ibatorgenerated_selectByPrimaryKey" resultMap="ibatorgenerated_BaseResultMap"
		parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Mar 14 11:27:55 
			CST 2016. -->
		select ID, loginId, INSTITUTION_CODE, REMARK1, REMARK2
		from CROWD_INSTITUTION_ADMININFO
		where ID = #id:DECIMAL#
	</select>
	<delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Mar 14 11:27:55 
			CST 2016. -->
		delete from CROWD_INSTITUTION_ADMININFO
		where ID = #id:DECIMAL#
	</delete>

	<insert id="ibatorgenerated_insert" parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<selectKey resultClass="java.lang.Integer" keyProperty="id">
	   		select SEQ_CR_INST_ADMIN.nextval from dual
	   </selectKey>
		insert into CROWD_INSTITUTION_ADMININFO (ID, loginId,
		INSTITUTION_CODE, REMARK1, REMARK2)
		values (#id:DECIMAL#, #loginId:DECIMAL#, #institutionCode:VARCHAR#,
		#remark1:VARCHAR#,
		#remark2:VARCHAR#)
	</insert>
	<insert id="ibatorgenerated_insertSelective" parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<selectKey resultClass="java.lang.Integer" keyProperty="id">
	   		select SEQ_CR_INST_ADMIN.nextval from dual
	   </selectKey>
		insert into CROWD_INSTITUTION_ADMININFO
		<dynamic prepend="(">
			<isNotNull prepend="," property="id">
				ID
			</isNotNull>
			<isNotNull prepend="," property="loginId">
				loginId
			</isNotNull>
			<isNotNull prepend="," property="institutionCode">
				INSTITUTION_CODE
			</isNotNull>
			<isNotNull prepend="," property="remark1">
				REMARK1
			</isNotNull>
			<isNotNull prepend="," property="remark2">
				REMARK2
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="id">
				#id:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="loginId">
				#loginId:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="institutionCode">
				#institutionCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="remark1">
				#remark1:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="remark2">
				#remark2:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>



	<update id="ibatorgenerated_updateByPrimaryKeySelective"
		parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Mar 14 11:27:55 
			CST 2016. -->
		update CROWD_INSTITUTION_ADMININFO
		<dynamic prepend="set">
			<isNotNull prepend="," property="loginId">
				loginId = #loginId:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="institutionCode">
				INSTITUTION_CODE = #institutionCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="remark1">
				REMARK1 = #remark1:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="remark2">
				REMARK2 = #remark2:VARCHAR#
			</isNotNull>
		</dynamic>
		where ID = #id:DECIMAL#
	</update>
	<update id="ibatorgenerated_updateByPrimaryKey" parameterClass="com.km.crowdsourcing.model.InstitutionAdmininfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Mar 14 11:27:55 
			CST 2016. -->
		update CROWD_INSTITUTION_ADMININFO
		set loginId = #loginId:DECIMAL#,
		INSTITUTION_CODE = #institutionCode:VARCHAR#,
		REMARK1 = #remark1:VARCHAR#,
		REMARK2 = #remark2:VARCHAR#
		where ID = #id:DECIMAL#
	</update>
	
	<update id="ibatorgenerated_activateIns_loginInfo" parameterClass="java.util.Map">
		update login_info
		set mobile = #mobile:VARCHAR#,
		LOGIN_PASSWORD = #password:VARCHAR#
		where n_login_id = (select LOGINID from crowd_institution_info cii  where cii.INSTITUTION_CODE = #institutionCode:VARCHAR#)
	</update>
	
	<update id="ibatorgenerated_activateIns_accountInfo" parameterClass="java.util.Map">
		update account_info
		set mobile = #mobile:VARCHAR#
		where N_LOGIN_ID = (select LOGINID from crowd_institution_info cii  where cii.INSTITUTION_CODE = #institutionCode:VARCHAR#)
	</update>
	
	<update id="ibatorgenerated_activateIns_insInfo" parameterClass="java.util.Map">
		update crowd_institution_info
		set ACT_STATE = 1
		where INSTITUTION_CODE = #institutionCode:VARCHAR#
	</update>
	
	<update id="ibatorgenerated_updatePassword" parameterClass="java.util.Map">
		update login_info
		set	LOGIN_PASSWORD = #password:VARCHAR#
		where mobile = #mobile:VARCHAR#
	</update>
	
	<update id="ibatorgenerated_updateLIVmobile" parameterClass="java.util.Map">
		update login_info
		set	MOBILE = #mobile:VARCHAR#
		where mobile = #mobileOld:VARCHAR#
	</update>
	
	<update id="ibatorgenerated_updateAIVmobile" parameterClass="java.util.Map">
		update account_info
		set	MOBILE = #mobile:VARCHAR#
		where mobile = #mobileOld:VARCHAR#
	</update>
	
	<!-- 查询机构用户信息，用于登录 -->
	<select id="ibatorgenerated_selectInfoForLogin" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[	
		select 
		li.login_account || '' loginAccount, 
		li.n_login_id || '' loginId,
		li.n_status || '' nStatus,
		li.mobile mobile,
		cii.status || '' status,
		cii.ACT_STATE || '' actState,
		cii.INSTITUTION_CODE institutionCode
		from login_info li right join crowd_institution_info cii 
		on li.n_login_id = cii.loginid 
		where UPPER(cii.institution_code) = UPPER(#name:VARCHAR#) and li.login_password= #password:VARCHAR#
		union
		select 
		li.login_account || '' loginAccount,
		li.n_login_id || '' loginId,
		li.n_status || '' nStatus,
		li.mobile mobile,
		cii.status || '' status,
		cii.ACT_STATE || '' actState,
		cii.INSTITUTION_CODE institutionCode
		from login_info li  right join crowd_institution_info cii 
		on li.n_login_id = cii.loginid 
		where li.mobile=#name:VARCHAR# and li.login_password=#password:VARCHAR#
	]]>	       
	</select>
	
	
	<!-- 查询机构相关信息，用于首页展示 -->
	<select id="ibatorgenerated_selectInsInfoForHomePage" parameterClass="java.lang.String" resultClass="java.util.HashMap">
	<![CDATA[
		select 
		   (select nvl(sum(ciu.clearing_amount),0) from  crowd_institution_user ciu where ciu.institution_code = #insCode:VARCHAR# and ciu.CLEARING_STATUS=1) totalAmount,
    	   (select  nvl(sum(ciu.clearing_amount),0) from  crowd_institution_user ciu where ciu.institution_code = #insCode:VARCHAR# and ciu.CLEARING_STATUS=0)	coldAmount,
    	   (select count(1) from  crowd_institution_user ciu where ciu.institution_code = #insCode:VARCHAR#) totalPersons,
           (select count(1) from  crowd_institution_user ciu where ciu.institution_code = #insCode:VARCHAR# and ciu.CREATE_TIME  >= To_date(To_char(Trunc(SYSDATE), 'yyyy/mm/dd hh24:mi:ss'), 'yyyy/mm/dd hh24:mi:ss')) todayPersons,
          (select MOBILE from login_info li where li.N_LOGIN_ID=(select LOGINID from crowd_institution_info where INSTITUTION_CODE=#insCode:VARCHAR#)) mobile,
          (select AMOUNT_AVLIBAL from account_info ai where ai.N_LOGIN_ID=(select LOGINID from crowd_institution_info where INSTITUTION_CODE=#insCode:VARCHAR#)) amountAvlibal,
          cii.INSTITUTION_CODE,
           cii.INSTITUTION_NAME,
           cii.REGIST_REBATE,
           cii.SPREAD_START_DATE,
           cii.SPREAD_END_DATE,
           cii.INSTITUTION_CONTACTOR,
           cii.INSTITUTION_PHONENUMBER,
           cii.INSTITUTION_ADDRESS,
           cii.CREATE_DATE,
           cii.BANK_ACCOUNT,
           cii.BANK_NAME,
           cii.BANK_UNAME
           from crowd_institution_info cii
           where 
           cii.institution_code = #insCode:VARCHAR#
	]]>	       
	</select>
	
	<!-- 根据inscode 查询loginAccount -->
	<select id="queryLoginAccountByInstitutioncode" parameterClass="java.lang.String" resultClass="java.lang.String">
	select li.login_account from
		crowd_institution_info  cii
		left join login_info li
		on cii.LOGINID = li.n_login_id
		where cii.institution_code = #institutionCode:VARCHAR#
	</select>
	
	
	
	
</sqlMap>