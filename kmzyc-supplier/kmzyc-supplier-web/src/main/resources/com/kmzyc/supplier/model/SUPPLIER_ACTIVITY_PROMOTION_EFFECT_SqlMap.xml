<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="SUPPLIER_ACTIVITY_PROMOTION_EFFECT">

	<resultMap id="promotionEffectMap" class="com.kmzyc.supplier.vo.ActivityInfoVo">
		<result column="ACTIVITY_ID" property="activityId" jdbcType="DECIMAL" />
		<result column="ACTIVITY_NAME" property="activityName"
			jdbcType="VARCHAR" />
		<result column="ACTIVITY_TYPE" property="activityType"
			jdbcType="DECIMAL" />
		<result column="ACTIVITY_STATUS" property="activityStatus"
			jdbcType="DECIMAL" />
		<result column="CHARGE_TYPE" property="chargeType" jdbcType="DECIMAL" />
		<result column="ENTRY_START_TIME" property="entryStartTime"
			jdbcType="TIMESTAMP" />
		<result column="ENTRY_END_TIME" property="entryEndTime"
			jdbcType="TIMESTAMP" />
		<result column="ACTIVITY_START_TIME" property="activityStartTime"
			jdbcType="TIMESTAMP" />
		<result column="ACTIVITY_END_TIME" property="activityEndTime"
			jdbcType="TIMESTAMP" />
			
		<result column="FIXED_CHARGE" property="fixedCharge"
			jdbcType="DECIMAL" />
		<result column="SINGLE_CHARGE" property="singleCharge"
			jdbcType="DECIMAL" />
		<result column="commissionRate" property="commissionRate" 
			jdbcType="DECIMAL" />
		
		<!-- <result column="SUPPLIER_ENTRY_ID" property="supplierEntryId"
			jdbcType="DECIMAL" /> -->
	</resultMap>
	
	<resultMap id="ibatorgenerated_BaseResultMap" class="com.pltfm.app.entities.OrderMain" >
	    <result column="order_id" property="orderId" jdbcType="DECIMAL" />
	    <result column="customer_account" property="customerAccount" jdbcType="VARCHAR" />
	    <result column="customer_name" property="customerName" jdbcType="VARCHAR" />
	    <result column="customer_mobile" property="customerMobile" jdbcType="VARCHAR" />
	    <result column="order_purchaser_name" property="orderPurchaserName" jdbcType="VARCHAR" />
	    <result column="order_purchaser_mobile" property="orderPurchaserMobile" jdbcType="VARCHAR" />
	    <result column="order_purchaser_tel" property="orderPurchaserTel" jdbcType="VARCHAR" />
	    <result column="order_purchaser_addr" property="orderPurchaserAddr" jdbcType="VARCHAR" />
	    <result column="order_purchaser_type" property="orderPurchaserType" jdbcType="DECIMAL" />
	    <result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
	    <result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
	    <result column="consignee_tel" property="consigneeTel" jdbcType="VARCHAR" />
	    <result column="consignee_addr" property="consigneeAddr" jdbcType="VARCHAR" />
	    <result column="pay_method" property="payMethod" jdbcType="DECIMAL" />
	    <result column="fare" property="fare" jdbcType="DECIMAL" />
	    <result column="delivery_date_type" property="deliveryDateType" jdbcType="DECIMAL" />
	    <result column="commodity_sum" property="commoditySum" jdbcType="DECIMAL" />
	    <result column="discount_amount" property="discountAmount" jdbcType="DECIMAL" />
	    <result column="account_balance" property="accountBalance" jdbcType="DECIMAL" />
	    <result column="amount_payable" property="amountPayable" jdbcType="DECIMAL" />
	    <result column="pay_date" property="payDate" jdbcType="date" />
	    <result column="create_date" property="createDate" jdbcType="date" />
	    <result column="agency_number" property="agencyNumber" jdbcType="VARCHAR" />
	    <result column="settlement_no" property="settlementNo" jdbcType="DECIMAL" />
	    <result column="stock_out_id" property="stockOutId" jdbcType="DECIMAL" />
	    <result column="distribution_id" property="distributionId" jdbcType="DECIMAL" />
	    <result column="logistics_order_no" property="logisticsOrderNo" jdbcType="VARCHAR" />
	    <result column="order_source" property="orderSource" jdbcType="VARCHAR" />
	    <result column="invoice_id" property="invoiceId" jdbcType="DECIMAL" />
	    <result column="parent_order_code" property="parentOrderCode" jdbcType="VARCHAR" />
	    <result column="son_order_code" property="sonOrderCode" jdbcType="VARCHAR" />
	    <result column="order_description" property="orderDescription" jdbcType="VARCHAR" />
	    <result column="order_status" property="orderStatus" jdbcType="DECIMAL" />
	    <result column="order_code" property="orderCode" jdbcType="VARCHAR" />
	    <result column="customer_id" property="customerId" jdbcType="DECIMAL" />
	    <result column="order_channel" property="orderChannel" jdbcType="VARCHAR" />
	    <result column="disabled" property="disabled" jdbcType="DECIMAL" />
	    <result column="confirm_delivery" property="confirmDelivery" jdbcType="DECIMAL" />
	    <result column="logistics_code" property="logisticsCode" jdbcType="VARCHAR" />
	    <result column="address_id" property="addressId" jdbcType="DECIMAL" />
	    <result column="email" property="email" jdbcType="VARCHAR" />
	    <result column="weight" property="weight" jdbcType="DECIMAL" />
	    <result column="assess_status" property="assessStatus" jdbcType="DECIMAL" />
	    <result column="finish_date" property="finishDate" jdbcType="date" />
	    <result column="invoice_info_type" property="invoiceInfoType" jdbcType="VARCHAR" />
	    <result column="INVOICE_INFO_TITLE" property="invoiceInfoTitle" jdbcType="VARCHAR" />
	    <result column="invoice_info_content" property="invoiceInfoContent" jdbcType="VARCHAR" />  
	    <result column="total_credit" property="totalCredit" jdbcType="DECIMAL" />  
	    <result column="logistics_name" property="logisticsName" jdbcType="VARCHAR" />
	    <result column="original_order_sum" property="originalOrderSum" jdbcType="DECIMAL" />  
	    <result column="province" jdbcType="VARCHAR" property="province" />
	    <result column="city" jdbcType="VARCHAR" property="city" />
	    <result column="area" jdbcType="VARCHAR" property="area" />
	    <result column="zipcode" jdbcType="DECIMAL" property="zipcode" />
	    <result column="order_type" property="orderType" jdbcType="DECIMAL" />
	    <result column="order_operation_remark" property="orderOperationRemark" jdbcType="VARCHAR" />
	    <result column="commerce_id" property="commerceId" jdbcType="VARCHAR" />
	    <result column="prize_numbers" property="prizeNumbers" jdbcType="VARCHAR" />
	    <result column="prescription_attachment" property="prescriptionAttachment" jdbcType="VARCHAR" />
	    <result column="check_flag" property="checkFlag" jdbcType="DECIMAL" />
	    <result column="medic_flag" property="medicFlag" jdbcType="DECIMAL" />
  </resultMap> 
    
    <resultMap class="com.pltfm.app.vobject.OrderMainVo" id="ibatorgenerated_ExtendsResultMap"
  		  extends="ibatorgenerated_BaseResultMap">
    <result column="paymethodstr" jdbcType="VARCHAR" property="payMethodStr" />
    <result column="deliverydatetypestr" jdbcType="VARCHAR" property="deliveryDateTypeStr" />
    <result column="orderstatusstr" jdbcType="VARCHAR" property="orderStatusStr" />
    <result column="handlestate" jdbcType="VARCHAR" property="handleState" />
    <result column="handleaccount" jdbcType="VARCHAR" property="handleAccount" />
  </resultMap>
  
	<resultMap class="com.pltfm.app.vobject.OrderMainVo" id="WithRoot_ResultMap"
  		  extends="ibatorgenerated_ExtendsResultMap">
	<result property="rootOrderCode" column="root_order_code"/>   
   </resultMap> 
  
	<resultMap class="com.kmzyc.supplier.model.OrderMain" id="extWithRootMap" extends="WithRoot_ResultMap">
	 <result property="orderItemList" column="order_code" select="SUPPLIER_ACTIVITY_PROMOTION_EFFECT.queryItemListByOrderCode"/>   
    </resultMap>
   
    <resultMap id="simpleResultMapForItem" class="com.pltfm.app.vobject.OrderItemVo" >
	    <result column="order_item_id" property="orderItemId" jdbcType="DECIMAL" />
	    <result column="order_code" property="orderCode" jdbcType="VARCHAR" />	    
	    <result column="commodity_unit_price" property="commodityUnitPrice" jdbcType="DECIMAL" />
	    <result column="commodity_number" property="commodityNumber" jdbcType="DECIMAL" />
	    <result column="commodity_sum" property="commoditySum" jdbcType="DECIMAL" />
	    <result column="image_url" property="imageUrl" jdbcType="VARCHAR" />
	    <result column="commodity_sku_description" property="commoditySkuDescription" jdbcType="VARCHAR" />
	    <result column="commodity_title" property="commodityTitle" jdbcType="VARCHAR" />
	    <result column="product_sku_id" property="productSkuId" jdbcType="DECIMAL"/>
	    <result column="commodity_sku" property="commoditySku" jdbcType="DECIMAL"/>
	    <!-- <result column="brand_name" property="brandName" jdbcType="DECIMAL"/> -->
	</resultMap>
  	
  	<!-- 依据订单号查询订单item -->
  <select id="queryItemListByOrderCode" resultMap="simpleResultMapForItem" parameterClass="java.lang.String" >
  	 <![CDATA[ 
  	 	select 
  	 		order_item_id, order_code, commodity_unit_price, commodity_number,
  	 		commodity_sum,image_url,commodity_sku_description,commodity_title,commodity_sku,
  	   		(select sku.product_sku_id from product_sku sku
  	   			where sku.product_sku_code = t.commodity_sku) product_sku_id,
  	   	    (select pb.brand_name
          	 from 
          	 	prod_brand  pb,
               	productmain pm,
               	product_sku psk
         	 where 
         	 	pb.brand_id = pm.brand_id
           	 and psk.product_id=pm.product_id
             and psk.product_sku_code = t.commodity_sku) as brandName
		  	 from order_item t where order_code=#orderCode#
  	 ]]>
  </select>
  
	<sql id="sql_where_list">
		<!-- <dynamic prepend="where"> -->
	        <isNotEmpty prepend="AND" property="objCondition.activityName">
	            <![CDATA[
	                AI.ACTIVITY_NAME like '%'||#objCondition.activityName#||'%'
	            ]]>
	        </isNotEmpty>
	        <isNotEmpty prepend="AND" property="objCondition.activityId">
	            <![CDATA[
	                AI.ACTIVITY_ID= #objCondition.activityId#
	            ]]>
	        </isNotEmpty>
	        <isNotEmpty prepend="AND" property="objCondition.activityStatus">
	            <![CDATA[
	                AI.ACTIVITY_STATUS = #objCondition.activityStatus#
	            ]]>
	        </isNotEmpty>
	        
	        <isNotEmpty prepend="AND" property="objCondition.activityType">
	            <![CDATA[
	                AI.ACTIVITY_TYPE = #objCondition.activityType#
	            ]]>
	        </isNotEmpty>
	         <isNotEmpty prepend="AND" property="objCondition.entryStartTime">
	            <![CDATA[
	                AI.ENTRY_START_TIME >= #objCondition.entryStartTime#
	            ]]>
	        </isNotEmpty>
	         <isNotEmpty prepend="AND" property="objCondition.entryEndTime">
	            <![CDATA[
	                AI.ENTRY_END_TIME < #objCondition.entryEndTime#
	            ]]>
	        </isNotEmpty>
	        <isNotEmpty prepend="AND" property="objCondition.activityStartTime">
	            <![CDATA[
	                AI.ACTIVITY_START_TIME >= #objCondition.activityStartTime#
	            ]]>
	        </isNotEmpty>
	        <isNotEmpty prepend="AND" property="objCondition.activityEndTime">
	            <![CDATA[
	                AI.ACTIVITY_END_TIME < #objCondition.activityEndTime#
	            ]]>
	        </isNotEmpty>
	        
            <isNotEmpty prepend="AND" property="objCondition.activityIn">
                <![CDATA[
					AI.ACTIVITY_END_TIME > sysdate AND AI.ACTIVITY_START_TIME < sysdate AND AI.ACTIVITY_STATUS != 8
				]]>
            </isNotEmpty>
            <isNotEmpty prepend="AND" property="objCondition.activityEnd">
                <![CDATA[
					AI.ACTIVITY_END_TIME < sysdate AND AI.ACTIVITY_STATUS != 8
				]]>
            </isNotEmpty>
		<!-- </dynamic> -->
    </sql>
    
	<!-- 分页查询活动推广效果列表 -->
	<select id="selectActivityResult" resultMap="promotionEffectMap"
		parameterClass="com.km.framework.page.Pagination">
			SELECT *
			  FROM (SELECT t.*, ROWNUM RN
			          FROM (SELECT AI.ACTIVITY_ID,
			                       AI.ACTIVITY_NAME,
			                       AI.ACTIVITY_TYPE,
			                       AI.CHARGE_TYPE,
			                       AC.SINGLE_CHARGE,
			                       AC.FIXED_CHARGE,
			                       AC.COMMISSION_RATE * 100 commissionRate,
			                       AI.ENTRY_START_TIME,
			                       AI.ENTRY_END_TIME,
			                       AI.ACTIVITY_START_TIME,
			                       AI.ACTIVITY_END_TIME,
			                       AI.ACTIVITY_STATUS,
			                       AI.CREATE_TIME,
			                       0 SUPPLIER_TYPE
			                  FROM ACTIVITY_INFO AI
			                  LEFT JOIN ACTIVITY_CHARGE AC
			                    ON AI.ACTIVITY_ID = AC.ACTIVITY_ID
			                 WHERE AI.AUDIT_STATUS = 1
			                   and (AI.ACTIVITY_STATUS = 8 or
			                       sysdate > AI.ACTIVITY_END_TIME or
			                       sysdate between AI.ACTIVITY_START_TIME and
			                       AI.ACTIVITY_END_TIME)
			                      <include refid="sql_where_list"/>
			                   AND EXISTS (select 1
			                          from ACTIVITY_SUPPLIER_ENTRY ASE
			                         WHERE ASE.ACTIVITY_ID = AI.ACTIVITY_ID
			                           AND ASE.SUPPLIER_ID = #objCondition.supplierId#
			                           and ase.entry_status = 2
			                           and ase.audit_status = 1)
			                 ORDER BY AI.Create_Time DESC) T
			        	<![CDATA[
			        		WHERE ROWNUM <= $endindex$) WHERE RN >= #startindex#
			        	]]>
	</select>

	<!-- 分页统计活动推广效果个数 -->
	<select id="countActivityResult" parameterClass="com.km.framework.page.Pagination"
		resultClass="java.lang.Integer">
		SELECT COUNT(1)
			  FROM (SELECT t.*, ROWNUM RN
			          FROM (SELECT AI.ACTIVITY_ID,
			                       AI.ACTIVITY_NAME,
			                       AI.ACTIVITY_TYPE,
			                       AI.CHARGE_TYPE,
			                       AC.SINGLE_CHARGE,
			                       AC.FIXED_CHARGE,
			                       AC.COMMISSION_RATE * 100 COMMISSION_RATE,
			                       AI.ENTRY_START_TIME,
			                       AI.ENTRY_END_TIME,
			                       AI.ACTIVITY_START_TIME,
			                       AI.ACTIVITY_END_TIME,
			                       AI.ACTIVITY_STATUS,
			                       AI.CREATE_TIME,
			                       0 SUPPLIER_TYPE
			                  FROM ACTIVITY_INFO AI
			                  LEFT JOIN ACTIVITY_CHARGE AC
			                    ON AI.ACTIVITY_ID = AC.ACTIVITY_ID
			                 WHERE AI.AUDIT_STATUS = 1
			                   and (AI.ACTIVITY_STATUS = 8 or
			                       sysdate > AI.ACTIVITY_END_TIME or
			                       sysdate between AI.ACTIVITY_START_TIME and
			                       AI.ACTIVITY_END_TIME)
			                      <include refid="sql_where_list"/>
			                   AND EXISTS (select 1
			                          from ACTIVITY_SUPPLIER_ENTRY ASE
			                         WHERE ASE.ACTIVITY_ID = AI.ACTIVITY_ID
			                           AND ASE.SUPPLIER_ID = #objCondition.supplierId#
			                           and ase.entry_status = 2
			                           and ase.audit_status = 1)
			                 ORDER BY AI.Create_Time DESC) T
			                 )
	</select>
	
	
	<!-- 统计促销/图文活动商品销量 -->
	<select id="countSPAndTxtProductSalesByParam" parameterClass="com.km.framework.page.Pagination"
		resultClass="java.lang.Integer">
		select count(1) FROM 
           (select T.Product_Title        as productName,
                       ask.activity_sku_id    as activitySkuId,
                       ask.activity_id        AS activityId,
                       ask.supplier_entry_id  AS supplierEntryId,
                       ask.sale_quantity      as saleQuantity,
                       ask.activity_price     AS activityPrice,
                       ask.activity_sku_image AS activitySkuImage,
                       T.Product_Sku_Code     AS productSkuCode,
                       T.Price                AS price,
                       T.product_sku_id       AS productSkuId
                  from activity_sku ask
                  left join activity_supplier_entry ase
                    ON ask.supplier_entry_id = ase.supplier_entry_id
                  left join (select *
                              from product_sku ps
                              left join productmain pm
                                on ps.product_id = pm.product_id) T
                    on ask.product_sku_id = T.PRODUCT_SKU_ID
                 where ask.activity_id = #objCondition.activityId#
                   and ase.supplier_id = #objCondition.supplierId#
                   and ask.audit_status = 1
                   and ase.entry_status = 2
                   and ase.audit_status = 1
                   and ask.activity_sku_type = 1
					<isNotNull property="objCondition.productSkuCode" >
				   		and T.Product_Sku_Code=#objCondition.productSkuCode#
				   	</isNotNull>
				   	<isNotNull property="objCondition.productName" >
				   		and T.Product_Title like '%'||#objCondition.productName#||'%'
				   	</isNotNull>
                ) A
	</select>
	
	<!-- 查询促销/图文活动商品销量 -->
	<select id="selectSPAndTxtProductSalesByParam" parameterClass="com.km.framework.page.Pagination"
		resultClass="com.pltfm.app.vobject.ActivitySku">
		select * FROM (select a.*, ROWNUM RN
          from (select T.Product_Title        as productName,
                       ask.activity_sku_id    as activitySkuId,
                       ask.activity_id        AS activityId,
                       ask.supplier_entry_id  AS supplierEntryId,
                       ask.sale_quantity      as saleQuantity,
                       ask.activity_price     AS activityPrice,
                       ask.activity_sku_image AS activitySkuImage,
                       T.Product_Sku_Code     AS productSkuCode,
                       T.Price                AS price,
                       T.product_sku_id       AS productSkuId
                  from activity_sku ask
                  left join activity_supplier_entry ase
                    ON ask.supplier_entry_id = ase.supplier_entry_id
                  left join (select *
                              from product_sku ps
                              left join productmain pm
                                on ps.product_id = pm.product_id) T
                    on ask.product_sku_id = T.PRODUCT_SKU_ID
                 where ask.activity_id = #objCondition.activityId#
                   and ase.supplier_id = #objCondition.supplierId#
                   and ask.audit_status = 1
                   and ase.entry_status = 2
                   and ase.audit_status = 1
                   and ask.activity_sku_type = 1
					<isNotNull property="objCondition.productSkuCode" >
				   		and T.Product_Sku_Code=#objCondition.productSkuCode#
				   	</isNotNull>
				   	<isNotNull property="objCondition.productName" >
				   		and T.Product_Title like '%'||#objCondition.productName#||'%'
				   	</isNotNull>
                ) A
         		<![CDATA[
         			WHERE ROWNUM <= $endindex$) WHERE RN >= #startindex#
         		]]>
	</select>
	
	<!-- 统计渠道活动商品销量 -->
	<select id="countChannelProductSalesByParam" parameterClass="com.km.framework.page.Pagination"
		resultClass="java.lang.Integer">
		  select COUNT(1)
          from (select T.Product_Title as productName,
                       ask.activity_id AS activityId,
                       ask.supplier_entry_id AS supplierEntryId,
                       ask.activity_price AS activityPrice,
                       ask.activity_sku_image AS activitySkuImage,
                       ask.commission_rate * 100 as commissionRate,
                       ask.pre_sale_quantity as preSaleQuantity,
                       ask.sale_quantity as saleQuantity,
                       T.PRODUCT_SKU_ID as productSkuId,
                       T.Product_Sku_Code AS productSkuCode,
                       T.Price as price
                  from activity_sku ask
                  left join activity_supplier_entry ase
                    ON ask.supplier_entry_id = ase.supplier_entry_id
                  left join (select *
                              from product_sku ps
                              left join productmain pm
                                on ps.product_id = pm.product_id) T
                    on ask.product_sku_id = T.PRODUCT_SKU_ID
                 where ask.activity_id = #objCondition.activityId#
                   and ase.supplier_id = #objCondition.supplierId#
                   and ask.audit_status = 1
                   and ask.activity_sku_type = 1
                   and ase.entry_status = 2
                   and ase.audit_status = 1
		   	<isNotNull property="objCondition.productSkuCode" >
		   		and T.Product_Sku_Code=#objCondition.productSkuCode#
		   	</isNotNull>
		   	<isNotNull property="objCondition.productName" >
		   		and T.Product_Title like '%'||#objCondition.productName#||'%'
		   	</isNotNull>
		   	) 
	</select>
	
	<!-- 查询渠道活动商品销量 -->
	<select id="selectChannelProductSalesByParam" parameterClass="com.km.framework.page.Pagination"
		resultClass="com.pltfm.app.vobject.ActivitySku">
		select *
  		FROM (select a.*, ROWNUM RN 
  			  from (
  			  select 
	           T.Product_Title        as productName,
	           ask.activity_id        AS activityId,
	           ask.supplier_entry_id  AS supplierEntryId,
	           ask.activity_price     AS activityPrice,
	           ask.activity_sku_image AS activitySkuImage,
	           ask.commission_rate*100 as commissionRate,
		       ask.pre_sale_quantity as preSaleQuantity,
		       ask.sale_quantity  as saleQuantity,
		       T.PRODUCT_SKU_ID as productSkuId,
	           T.Product_Sku_Code     AS productSkuCode,
	           T.Price as  price
		      from activity_sku ask
		      left join activity_supplier_entry ase
		        ON ask.supplier_entry_id = ase.supplier_entry_id
		      left join (select *
		                   from product_sku ps
		                   left join productmain pm
		                     on ps.product_id = pm.product_id) T
		        on ask.product_sku_id = T.PRODUCT_SKU_ID
		     where ask.activity_id = #objCondition.activityId#
		       and ase.supplier_id = #objCondition.supplierId#
		       and ask.audit_status = 1
		       and ask.activity_sku_type = 1
		       and ase.entry_status=2
	       	   and ase.audit_status=1
		   	<isNotNull property="objCondition.productSkuCode" >
		   		and T.Product_Sku_Code=#objCondition.productSkuCode#
		   	</isNotNull>
		   	<isNotNull property="objCondition.productName" >
		   		and T.Product_Title like '%'||#objCondition.productName#||'%'
		   	</isNotNull>
		   	) A
		   	<![CDATA[
         		WHERE ROWNUM <= $endindex$) WHERE RN >= #startindex#
         	]]>
	</select>
	
	<!-- 统计活动商家首次预售数量 -->
	<select id="countFirstPreSaleQuantity" parameterClass="map" resultClass="int">
		 select t.pre_sale_quantity
  			from ACTIVITY_SKU t
		  left join activity_supplier_entry
		    on t.activity_id = activity_supplier_entry.activity_id
		 where
		 	   t.activity_sku_type = 1
		   and t.activity_id = #activityId#
		   and t.audit_status = 1
		   and activity_supplier_entry.supplier_id = #supplierId#
		   and t.product_sku_id=#productSkuId#
	</select>
	
	<!-- 统计追加数量 -->
	<select id="countAppendPreSaleQuantity" parameterClass="map" resultClass="int">
		select sum(t.pre_sale_quantity)
		  from ACTIVITY_SKU t
		  left join activity_supplier_entry
		    on t.activity_id = activity_supplier_entry.activity_id
		 where t.activity_sku_type = 2
		   and t.activity_id = #activityId#
		   and t.audit_status=1
		   and activity_supplier_entry.supplier_id = #supplierId#
		   and t.product_sku_id=#productSkuId#
	</select>
	 
	<!-- 分页查询活动商家追加明细 -->
	<select id="selectAppendProductListByParam" parameterClass="com.km.framework.page.Pagination" resultClass="com.pltfm.app.vobject.ActivitySku">
		SELECT *
  		FROM (select AA.*, ROWNUM RN
          	  FROM (select *
                  from (select ask.activity_id as activityId,
                               T.Product_Title as productName,
                               T.product_sku_code as productSkuCode,
                               ask.activity_price as activityPrice,
                               ask.commission_rate * 100 as commissionRate,
                               ask.pre_sale_quantity as preSaleQuantity,
                               ask.sku_total_price as skuTotalPrice,
                               ask.create_time as createTime,
                               T.Price as price
                          from ACTIVITY_SKU ask
                          left join (select *
                                      from product_sku ps
                                      left join productmain pm
                                        on ps.product_id = pm.product_id) T
                            on ask.product_sku_id = T.product_sku_id
                         where ask.activity_sku_type = 2
                           and ask.activity_id = #objCondition.activityId#
                           and ask.product_sku_id = #objCondition.skuId#
                           and ask.audit_status = 1) A,
                       activity_supplier_entry ase
                 where A.activityId = ase.activity_id
                   and ase.supplier_id = #objCondition.supplierId#
                   <isNotNull property="objCondition.productSkuCode" >
				   		and productSkuCode=#objCondition.productSkuCode#
				   	</isNotNull>
					<isNotNull property="objCondition.productName" >
				   		and productName like '%'||#objCondition.productName#||'%'
				   	</isNotNull>
                   ) AA
         			<![CDATA[
			        	WHERE ROWNUM <= $endindex$) WHERE RN >= #startindex#
			        ]]>
	   	
	</select>
	
	<!-- 分页统计查询活动商家追加明细数量 -->
	<select id="countAppendProductByParam" parameterClass="com.km.framework.page.Pagination" resultClass="java.lang.Integer">
		SELECT count(1)
  		FROM (select AA.*, ROWNUM RN
          	  FROM (select *
                  from (select ask.activity_id as activityId,
                               T.Product_Title as productName,
                               T.product_sku_code as productSkuCode,
                               ask.activity_price as activityPrice,
                               ask.commission_rate * 100 as commissionRate,
                               ask.pre_sale_quantity as preSaleQuantity,
                               ask.sku_total_price as skuTotalPrice,
                               ask.create_time as createTime,
                               T.Price as price
                          from ACTIVITY_SKU ask
                          left join (select *
                                      from product_sku ps
                                      left join productmain pm
                                        on ps.product_id = pm.product_id) T
                            on ask.product_sku_id = T.product_sku_id
                         where ask.activity_sku_type = 2
                           and ask.activity_id = #objCondition.activityId#
                           and ask.product_sku_id = #objCondition.skuId#
                           and ask.audit_status = 1) A,
                       activity_supplier_entry ase
                 where A.activityId = ase.activity_id
                   and ase.supplier_id = #objCondition.supplierId#
                   <isNotNull property="objCondition.productSkuCode" >
				   		and productSkuCode=#objCondition.productSkuCode#
				   	</isNotNull>
					<isNotNull property="objCondition.productName" >
				   		and productName like '%'||#objCondition.productName#||'%'
				   	</isNotNull>
                   ) AA)
                   
	</select>
    
    <sql id="Map_Where_Clause">
		from order_main om where 1=1 and om.order_status != -3
		<!-- 订单状态  -->
		<isNotEmpty prepend="AND" property="objCondition.orderStatus">
			om.order_status = #objCondition.orderStatus#
		</isNotEmpty>
		<!-- 订单状态  -->
		<isNotEmpty prepend="AND" property="objCondition.status">
			om.order_status = #objCondition.status#
		</isNotEmpty>
		<!-- 订单号 -->
		<isNotEmpty prepend="AND" property="objCondition.orderCode">
			om.order_code = #objCondition.orderCode# 
		</isNotEmpty>
		<!-- 订单号 -->
		<isNotEmpty prepend="AND" property="objCondition.orderCodeArr">
			om.order_code in
			<iterate open="(" close=")" conjunction="," property="objCondition.orderCodeArr">  
 				<![CDATA[#objCondition.orderCodeArr[]#]]>
			</iterate> 
		</isNotEmpty>
		<!-- 下单时间开始时间  -->
		<isNotEmpty prepend="AND" property="objCondition.createDateStart">
		<![CDATA[
			trunc(om.create_date,'mi')>=to_date(#objCondition.createDateStart#,'yyyy-MM-dd HH24:mi:ss')
		]]>
		</isNotEmpty>
		<!-- 下单结束时间 -->
		<isNotEmpty prepend="AND" property="objCondition.createDateEnd">
		<![CDATA[
			 trunc(om.create_date,'mi')<=to_date(#objCondition.createDateEnd#,'yyyy-MM-dd HH24:mi:ss')
		]]>
		</isNotEmpty>
		<isNotEmpty  prepend="AND" property="objCondition.statusArr">
			om.order_status in
			<iterate open="(" close=")" conjunction="," property="objCondition.statusArr">  
 				<![CDATA[#objCondition.statusArr[]#]]>
			</iterate> 
		</isNotEmpty>
	</sql>
	
    <select id="selectProductSalesDetailByParam"  parameterClass="com.km.framework.page.Pagination"  resultMap="extWithRootMap">
		select tt.order_id,
       tt.customer_account,
       tt.customer_name,
       tt.customer_mobile,
       tt.order_purchaser_name,
       tt.order_purchaser_mobile,
       tt.order_purchaser_tel,
       tt.order_purchaser_addr,
       tt.order_purchaser_type,
       tt.consignee_name,
       tt.consignee_mobile,
       tt.consignee_tel,
       tt.consignee_addr,
       tt.pay_method,
       tt.fare,
       tt.delivery_date_type,
       tt.commodity_sum,
       tt.discount_amount,
       tt.account_balance,
       tt.amount_payable,
       tt.pay_date,
       tt.create_date,
       tt.agency_number,
       tt.settlement_no,
       tt.stock_out_id,
       tt.distribution_id,
       tt.logistics_order_no,
       tt.order_source,
       tt.invoice_id,
       tt.parent_order_code,
       tt.son_order_code,
       tt.order_description,
       tt.order_status,
       tt.order_code,
       tt.customer_id,
       tt.disabled,
       tt.confirm_delivery,
       tt.logistics_code,
       tt.address_id,
       tt.email,
       tt.weight,
       tt.assess_status,
       tt.finish_date,
       tt.invoice_info_type,
       tt.invoice_info_title,
       tt.invoice_info_content,
       tt.total_credit,
       tt.logistics_name,
       tt.original_order_sum,
       tt.province,
       tt.city,
       tt.area,
       tt.zipcode,
       tt.order_type,
       tt.order_operation_remark,
       tt.commerce_id,
       tt.prize_numbers,
       tt.prescription_attachment,
       tt.check_flag,
       tt.medic_flag
      ,
       (select d.order_dictionary_value
          from order_dictionary d
         where d.order_dictionary_type = 'Pay_Method'
           and d.order_dictionary_key = tt.pay_method) paymethodstr,
       (select d.order_dictionary_value
          from order_dictionary d
         where d.order_dictionary_type = 'Delivery_Date_Type'
           and d.order_dictionary_key = tt.delivery_date_type) deliverydatetypestr,
       (select d.order_dictionary_value
          from order_dictionary d
         where d.order_dictionary_type = 'Order_Status'
           and d.order_dictionary_key = tt.order_status) orderstatusstr,
       (case
         when tt.parent_order_code is null then
          null
         else
          (select order_code
             from order_main e
            where connect_by_isleaf = 1
            start with e.order_code = tt.order_code
           connect by e.order_code = prior e.parent_order_code)
       end) root_order_code,
       (select handle_state
          from order_handle
         where order_code = tt.order_code) handlestate,
       (select handle_account
          from order_handle
         where order_code = tt.order_code) handleaccount
  from (select t.order_id,
               t.customer_account,
               t.customer_name,
               t.customer_mobile,
               t.order_purchaser_name,
               t.order_purchaser_mobile,
               t.order_purchaser_tel,
               t.order_purchaser_addr,
               t.order_purchaser_type,
               t.consignee_name,
               t.consignee_mobile,
               t.consignee_tel,
               t.consignee_addr,
               t.pay_method,
               t.fare,
               t.delivery_date_type,
               t.commodity_sum,
               t.discount_amount,
               t.account_balance,
               t.amount_payable,
               t.pay_date,
               t.create_date,
               t.agency_number,
               t.settlement_no,
               t.stock_out_id,
               t.distribution_id,
               t.logistics_order_no,
               t.order_source,
               t.invoice_id,
               t.parent_order_code,
               t.son_order_code,
               t.order_description,
               t.order_status,
               t.order_code,
               t.customer_id,
               t.disabled,
               t.confirm_delivery,
               t.logistics_code,
               t.address_id,
               t.email,
               t.weight,
               t.assess_status,
               t.finish_date,
               t.invoice_info_type,
               t.invoice_info_title,
               t.invoice_info_content,
               t.total_credit,
               t.logistics_name,
               t.original_order_sum,
               t.province,
               t.city,
               t.area,
               t.zipcode,
               t.order_type,
               t.order_operation_remark,
               t.commerce_id,
               t.prize_numbers,
               t.prescription_attachment,
               t.check_flag,
               t.medic_flag,
               rownum rn
          from (select distinct om.order_id,
                                om.customer_account,
                                om.customer_name,
                                om.customer_mobile,
                                om.order_purchaser_name,
                                om.order_purchaser_mobile,
                                om.order_purchaser_tel,
                                om.order_purchaser_addr,
                                om.order_purchaser_type,
                                om.consignee_name,
                                om.consignee_mobile,
                                om.consignee_tel,
                                om.consignee_addr,
                                om.pay_method,
                                om.fare,
                                om.delivery_date_type,
                                om.commodity_sum,
                                om.discount_amount,
                                om.account_balance,
                                om.amount_payable,
                                om.pay_date,
                                om.create_date,
                                om.agency_number,
                                om.settlement_no,
                                om.stock_out_id,
                                om.distribution_id,
                                om.logistics_order_no,
                                om.order_source,
                                om.invoice_id,
                                om.parent_order_code,
                                om.son_order_code,
                                om.order_description,
                                om.order_status,
                                om.order_code,
                                om.customer_id,
                                om.disabled,
                                om.confirm_delivery,
                                om.logistics_code,
                                om.address_id,
                                om.email,
                                om.weight,
                                om.assess_status,
                                om.finish_date,
                                om.invoice_info_type,
                                om.invoice_info_title,
                                om.invoice_info_content,
                                om.total_credit,
                                logistics_name,
                                original_order_sum,
                                om.province,
                                om.city,
                                om.area,
                                om.zipcode,
                                om.order_type,
                                om.order_operation_remark,
                                om.commerce_id,
                                om.prize_numbers,
                                om.prescription_attachment,
                                om.check_flag,
                                om.medic_flag
  		<include refid="Map_Where_Clause"/>
  		order by om.create_date desc) t
        <!-- where rownum  &lt;= #skip# -->
        ) tt  
		<!-- where tt.rn  &gt;= #max#  -->
  </select>
  
  <select id="countProductSalesDetailByParam" parameterClass="com.km.framework.page.Pagination"  resultClass="java.lang.Integer">
  	select count(1)	        
  		from (select 	t.order_id, t.customer_account, t.customer_name, t.customer_mobile, t.order_purchaser_name, 
						t.order_purchaser_mobile, t.order_purchaser_tel, t.order_purchaser_addr, t.order_purchaser_type, 
						t.consignee_name, t.consignee_mobile, t.consignee_tel, t.consignee_addr, t.pay_method, t.fare, 
						t.delivery_date_type, t.commodity_sum, t.discount_amount, t.account_balance, t.amount_payable, 
						t.pay_date, t.create_date, t.agency_number, t.settlement_no, t.stock_out_id, t.distribution_id, 
						t.logistics_order_no, t.order_source, t.invoice_id, t.parent_order_code, t.son_order_code, 
						t.order_description, t.order_status, t.order_code, t.customer_id,  t.disabled,
						t.confirm_delivery, t.logistics_code, t.address_id, t.email, t.weight, t.assess_status, t.finish_date,
       					t.invoice_info_type,t.invoice_info_title,t.invoice_info_content,t.total_credit ,t.logistics_name,t.original_order_sum,
       					t.province,t.city,t.area,t.zipcode,t.order_type,t.order_operation_remark,t.commerce_id,t.prize_numbers,
       					t.prescription_attachment,t.check_flag,t.medic_flag,rownum rn
        from(select distinct 	om.order_id, om.customer_account, om.customer_name, om.customer_mobile, om.order_purchaser_name, 
								om.order_purchaser_mobile, om.order_purchaser_tel, om.order_purchaser_addr, om.order_purchaser_type, 
								om.consignee_name, om.consignee_mobile, om.consignee_tel, om.consignee_addr, om.pay_method, om.fare, 
								om.delivery_date_type, om.commodity_sum, om.discount_amount, om.account_balance, om.amount_payable, 
								om.pay_date, om.create_date, om.agency_number, om.settlement_no, om.stock_out_id, om.distribution_id, 
								om.logistics_order_no, om.order_source, om.invoice_id, om.parent_order_code, om.son_order_code, 
								om.order_description, om.order_status, om.order_code, om.customer_id, om.disabled,
								om.confirm_delivery, om.logistics_code, om.address_id, om.email, om.weight, om.assess_status, om.finish_date,
  								om.invoice_info_type,om.invoice_info_title,om.invoice_info_content,om.total_credit,logistics_name,original_order_sum,
       							om.province,om.city,om.area,om.zipcode,om.order_type,om.order_operation_remark,om.commerce_id,om.prize_numbers,
       							om.prescription_attachment,om.check_flag,om.medic_flag
  		<include refid="Map_Where_Clause"/>
  		order by om.create_date desc) t
        <!-- where rownum  &lt;= #end# -->
        ) tt  
		<!-- where tt.rn  &gt;= #start# -->
  </select>
  
</sqlMap>