<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="WX_CONSUME_CODE_RECORD" >
  <resultMap id="ibatorgenerated_BaseResultMap" class="com.kmzyc.b2b.third.model.wxCard.WxConsumeCodeRecord" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Jan 26 10:30:58 CST 2015.
    -->
    <result column="SHOP_VERIFY_CODE" property="shopVerifyCode" jdbcType="VARCHAR" />
    <result column="CARD_ID" property="cardId" jdbcType="VARCHAR" />
    <result column="OPEN_ID" property="openId" jdbcType="VARCHAR" />
    <result column="CONSUME_DATE" property="consumeDate" jdbcType="DATE" />
  </resultMap>
  
  <!-- 激活码code map -->
  <resultMap id="activeCodeMap" class="com.kmzyc.b2b.third.model.wxCard.QueryPara" >
    <result column="active_code" property="code" jdbcType="VARCHAR" />
  </resultMap>


  <insert id="ibatorgenerated_insert" parameterClass="com.kmzyc.b2b.third.model.wxCard.WxConsumeCodeRecord" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Jan 26 10:30:58 CST 2015.
    -->
    insert into WX_CONSUME_CODE_RECORD (SHOP_VERIFY_CODE, CARD_ID, OPEN_ID, CONSUME_DATE,code)
    values (#shopVerifyCode:VARCHAR#, #cardId:VARCHAR#, #openId:VARCHAR#,sysdate,#code:code#)
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="com.kmzyc.b2b.third.model.wxCard.WxConsumeCodeRecord" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Jan 26 10:30:58 CST 2015.
    -->
    insert into WX_CONSUME_CODE_RECORD
    <dynamic prepend="(" >
      <isNotNull prepend="," property="shopVerifyCode" >
        SHOP_VERIFY_CODE
      </isNotNull>
      <isNotNull prepend="," property="cardId" >
        CARD_ID
      </isNotNull>
      <isNotNull prepend="," property="openId" >
        OPEN_ID
      </isNotNull>
      <isNotNull prepend="," property="consumeDate" >
        CONSUME_DATE
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(" >
      <isNotNull prepend="," property="shopVerifyCode" >
        #shopVerifyCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="cardId" >
        #cardId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="openId" >
        #openId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="consumeDate" >
        #consumeDate:DATE#
      </isNotNull>
      )
    </dynamic>
  </insert>

	<!-- 查询所需导入的券code  -->
    <select id="queryCode"  resultMap="activeCodeMap" parameterClass="com.kmzyc.b2b.third.model.wxCard.QueryPara">
		<![CDATA[
         select active_code
           from (select a.active_code, rownum rn
                   from $tableName$ a
                  order by active_code) b
          where b.rn >= #startIndex#
            and b.rn < #endIndex#
		]]>
	</select>
	
	
	<!-- 查询可供导入的code -->
    <select id="queryCodeForTest"  resultMap="activeCodeMap" parameterClass="com.kmzyc.b2b.third.model.wxCard.QueryPara">
		<![CDATA[
			   select active_code
              from (select rownum as num, active_code
                      from coupon_grant_info a
                     where exists
                           (select coupon_grant_id
                              from coupon_grant b
                             where coupon_id = #couponId#
                             and a.coupon_grant_id=b.coupon_grant_id
                               and grant_type = 61)
                     order by active_code asc)
             where num >= #startIndex#
               and num < #endIndex#			  
		]]>
	</select>
	
	<!-- 查询验证码是否存在 -->
	<select id="queryVerifyCode"  resultClass="java.lang.Integer" parameterClass="com.kmzyc.b2b.third.model.wxCard.QueryPara">
		<![CDATA[
			 select count(id) from wx_shop_verify_code where shop_verfify_code=#shopVerifyCode#
		]]>
	</select>
	
	<!-- 按照cardId和code查询该卡券是否已经重复提交 -->
	<select id="queryConsumeInfoByCardIdAndCode"  resultClass="java.lang.Integer" parameterClass="com.kmzyc.b2b.third.model.wxCard.WxConsumeCodeRecord">
		<![CDATA[
			 select count(*) from wx_consume_code_record where card_id=#cardId:VARCHAR# and code=#code:VARCHAR#
		]]>
	</select>
	
	<!-- 查询康美人生所有的门店信息 -->
	<select id="queryKmrsInfo" resultClass="com.kmzyc.b2b.third.model.wxCard.WxKmrsShopInfo">
		<![CDATA[
			select shop_id as shopId, branch_name as branchName, branch_province as branchProvince, detail_address as detailAddress, telephone as telephone from wx_kmrs_shop_info
		]]>
	</select>
	
</sqlMap>