<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="COUPON" >
    
    <typeAlias alias="pagination" type="com.km.framework.page.Pagination" />
    <!-- table:coupon-->
  <resultMap id="ibatorgenerated_BaseResultMap" class="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    <result column="COUPON_ID" property="couponId" jdbcType="DECIMAL" />
    <result column="COUPON_GIVETYPE_ID" property="couponGivetypeId" jdbcType="DECIMAL" />
    <result column="COUPON_NAME" property="couponName" jdbcType="VARCHAR" />
    <result column="COUPON_DESCRIBE" property="couponDescribe" jdbcType="VARCHAR" />
    <result column="COUPON_MONEY" property="couponMoney" jdbcType="DECIMAL" />
    <result column="STARTTIME" property="starttime" jdbcType="DATE" />
    <result column="ENDTIME" property="endtime" jdbcType="DATE" />
    <result column="CREATETIME" property="createtime" jdbcType="DATE" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="CUSTOM_LEVEID" property="customLeveid" jdbcType="VARCHAR" />
    <result column="CUSTOM_REG_START" property="customRegStart" jdbcType="DATE" />
    <result column="CUSTOM_REG_END" property="customRegEnd" jdbcType="DATE" />
    <result column="PAY_LEAST_MONEY" property="payLeastMoney" jdbcType="DECIMAL" />
    <result column="CUSTOM_ID" property="customId" jdbcType="VARCHAR" />
    <result column="IS_GRANT" property="isGrant" jdbcType="VARCHAR" />
    <result column="COUPON_VALID_DAY" property="couponValidDay" jdbcType="DECIMAL" />
    <result column="TIME_TYPE" property="timeType" jdbcType="DECIMAL" />
    <result column="USE_LIMITS_TYPE" property="useLimitsType" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="COUPON_LA" class="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    <result column="COUPON_ID" property="couponId" jdbcType="DECIMAL" />
    <result column="COUPON_GIVETYPE_ID" property="couponGivetypeId" jdbcType="DECIMAL" />
    <result column="COUPON_NAME" property="couponName" jdbcType="VARCHAR" />
    <result column="COUPON_DESCRIBE" property="couponDescribe" jdbcType="VARCHAR" />
    <result column="COUPON_MONEY" property="couponMoney" jdbcType="DECIMAL" />
    <result column="CREATETIME" property="createtime" jdbcType="DATE" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="CUSTOM_LEVEID" property="customLeveid" jdbcType="VARCHAR" />
    <result column="CUSTOM_REG_START" property="customRegStart" jdbcType="DATE" />
    <result column="CUSTOM_REG_END" property="customRegEnd" jdbcType="DATE" />
    <result column="PAY_LEAST_MONEY" property="payLeastMoney" jdbcType="DECIMAL" />
    <result column="CUSTOM_ID" property="customId" jdbcType="VARCHAR" />
    <result column="IS_GRANT" property="isGrant" jdbcType="VARCHAR" />
    <result column="COUPON_VALID_DAY" property="couponValidDay" jdbcType="DECIMAL" />
    <result column="use_limits_type" property="useLimitsType" jdbcType="VARCHAR" ></result>
  </resultMap>
  
  <resultMap id="couponGrant"  class="com.kmzyc.b2b.model.CouponGrant"  >
    <result column="COUPON_GRANT_ID" property="couponGrantId" jdbcType="DECIMAL" />
    <result column="COUPON_ID" property="couponId" jdbcType="DECIMAL" />
    <result column="CUSTOM_ID" property="customId" jdbcType="DECIMAL" />
    <result column="COUPON_STATUS" property="couponStatus" jdbcType="DECIMAL" />
      <!-- 10.29新增 -->
    <result column="grant_creattime" property="grantCreattime" jdbcType="VARCHAR"    />
    <result column="GRANT_CRATEMAN" property="grantCreateman" jdbcType="DECIMAL"   />
    <result column="grant_updatetime" property="grantUpdatetime" jdbcType="VARCHAR"  />
    <result column="grant_updateman" property="grantUpdateman" jdbcType="DECIMAL"  />
    <result column="GRANT_TYPE" property="grantType"  jdbcType="DECIMAL" />
    <result column="GRANT_RELATED_CODE" property="grantRelatedCode"  jdbcType="VARCHAR" />
    <result column="GRANT_REMARK" property="grantRemark"  jdbcType="VARCHAR" />
    <result column="GRANT_ENDTIME" property="grantEndtime"  jdbcType="VARCHAR" />
  </resultMap>
  
  <!-- table:couponGrant -->
   <resultMap id="COUPON_GRANT_MAP"  class="com.kmzyc.b2b.model.CouponGrant"  >
    <result column="COUPON_GRANT_ID" property="couponGrantId" jdbcType="DECIMAL" />
    <result column="COUPON_ID" property="couponId" jdbcType="DECIMAL" />
    <result column="CUSTOM_ID" property="customId" jdbcType="DECIMAL" />
    <result column="COUPON_STATUS" property="couponStatus" jdbcType="DECIMAL" />
    <result property="couponList" resultMap="COUPON.COUPON_LA"/>   
      <!-- 10.29新增 -->
    <result column="grant_creattime" property="grantCreattime" jdbcType="VARCHAR"    />
    <result column="GRANT_CRATEMAN" property="grantCreateman" jdbcType="DECIMAL"   />
    <result column="grant_updatetime" property="grantUpdatetime" jdbcType="VARCHAR"  />
    <result column="grant_updateman" property="grantUpdateman" jdbcType="DECIMAL"  />
    <result column="GRANT_TYPE" property="grantType"  jdbcType="DECIMAL" />
    <result column="GRANT_RELATED_CODE" property="grantRelatedCode"  jdbcType="VARCHAR" />
    <result column="GRANT_REMARK" property="grantRemark"  jdbcType="VARCHAR" />
    <result column="GRANT_ENDTIME" property="grantEndtime"  jdbcType="VARCHAR" />
    <!-- 11.20新增 -->
     <result column="STARTTIME_COUPON" property="starttime_coupon"  jdbcType="TIMESTAMP" />
     <result column="ENDTIME_COUPON" property="endtime_coupon"  jdbcType="TIMESTAMP" />
     <result column="GRANT_ACTTIME" property="grant_acttime"  jdbcType="TIMESTAMP" />
  </resultMap>
  

  <!-- 查询条件sql -->
  <sql id="byPageCountCondition">
    <isNotEmpty property="objCondition.userId" prepend="and">
		<![CDATA[
		   g.CUSTOM_ID = #objCondition.userId:NUMBER#
	    ]]>
	    </isNotEmpty>
	    <isNotEmpty property="objCondition.keyword" prepend="and">
	       c.COUPON_NAME  LIKE   '%'||#objCondition.keyword#||'%'
	    </isNotEmpty>
	    
	    <isNotNull property="objCondition.orderItem1"><!-- 无效： 时间不在and状态未使用 、状态以过期 -->
  	        <isNotEmpty property="objCondition.couponStatus" prepend="and"  >
  	              ((g.coupon_status = 3
 				and  sysdate >  g.endtime) or g.coupon_status in 
				<iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	       	    </iterate>
					)
			</isNotEmpty> 
  	   </isNotNull>
  	    
  	    <isNotNull property="objCondition.orderItem2"> <!-- 已使用 不用变 -->
  	        <isNotEmpty property="objCondition.couponStatus" prepend="and"  >
			   	 g.coupon_status in 	
			 <iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	         </iterate> 
			</isNotEmpty> 
  	   </isNotNull>
  	    
  	    <isNotNull property="objCondition.orderItem3"><!-- 未使用 ：时间在and状态在 -->
			<isNotEmpty property="objCondition.couponStatus" prepend="and"  >
				(g.coupon_status in 	
			 <iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	         </iterate> 
	            <![CDATA[
               		 and sysdate  <=   g.ENDTIME
                ]]>
	        	 ) 
			</isNotEmpty> 
		</isNotNull>
  </sql>
  
  	<sql id="byUserIdCondition">
		<![CDATA[
		   g.CUSTOM_ID = #objCondition.userId:NUMBER#
	    ]]>
	</sql>
  	<sql id="byPageCondition">
  	   <isNotNull property="objCondition.orderItem1"><!-- 无效： 时间不在and状态未使用 、状态以过期 -->
  	        <isNotEmpty property="objCondition.couponStatus" prepend="and"  >
  	              ((g.coupon_status = 3
 				and  sysdate >  g.endtime) or g.coupon_status in 
				<iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	       	    </iterate>
					)
			</isNotEmpty> 
  	   </isNotNull>
  	    
  	    <isNotNull property="objCondition.orderItem2"> <!-- 已使用 不用变 -->
  	        <isNotEmpty property="objCondition.couponStatus" prepend="and"  >
			   	 g.coupon_status in 	
			 <iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	         </iterate> 
			</isNotEmpty> 
  	   </isNotNull>
  	    
  	    <isNotNull property="objCondition.orderItem3"><!-- 未使用 ：时间在and状态在 -->
			<isNotEmpty property="objCondition.couponStatus" prepend="and"  >
				(g.coupon_status in 	
			 <iterate open="(" close=")" conjunction=","  property="objCondition.couponStatus"> 
	                #objCondition.couponStatus[]# 
	         </iterate> 
	             
	            <![CDATA[
               		 and sysdate  <=   g.ENDTIME
                ]]>
	        	 ) 
			</isNotEmpty> 
		</isNotNull>
		
		<isNotEmpty property="objCondition.keyword" prepend="and">
			<![CDATA[
				c.COUPON_NAME  LIKE   '%'||#objCondition.keyword#||'%'
			]]>
		</isNotEmpty>
	</sql>
	
  
  <select id="ibatorgenerated_selectByPrimaryKey" resultMap="ibatorgenerated_BaseResultMap" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    select COUPON_ID, COUPON_GIVETYPE_ID, COUPON_NAME, COUPON_DESCRIBE, COUPON_MONEY, STARTTIME,
    ENDTIME, CREATETIME, STATUS, CUSTOM_LEVEID, CUSTOM_REG_START, CUSTOM_REG_END, PAY_LEAST_MONEY,
    CUSTOM_ID, IS_GRANT, COUPON_VALID_DAY,TIME_TYPE
    from COUPON
    where COUPON_ID = #couponId:DECIMAL#
  </select>
  
  <delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    delete from COUPON
    where COUPON_ID = #couponId:DECIMAL#
  </delete>
   
  <insert id="ibatorgenerated_insert" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    insert into COUPON (COUPON_ID, COUPON_GIVETYPE_ID, COUPON_NAME, COUPON_DESCRIBE, COUPON_MONEY,
      STARTTIME, ENDTIME, CREATETIME, STATUS, CUSTOM_LEVEID, CUSTOM_REG_START, CUSTOM_REG_END,
      PAY_LEAST_MONEY, CUSTOM_ID, IS_GRANT, COUPON_VALID_DAY)
      values (#couponId:DECIMAL#, #couponGivetypeId:DECIMAL#, #couponName:VARCHAR#,
      #couponDescribe:VARCHAR#, #couponMoney:DECIMAL#, #starttime:DATE#, #endtime:DATE#,
      #createtime:DATE#, #status:DECIMAL#, #customLeveid:VARCHAR#, #customRegStart:DATE#,
      #customRegEnd:DATE#, #payLeastMoney:DECIMAL#, #customId:VARCHAR#, #isGrant:VARCHAR#,
      #couponValidDay:DECIMAL#)
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    insert into COUPON
    <dynamic prepend="(" >
      <isNotNull prepend="," property="couponId" >
        COUPON_ID
      </isNotNull>
      <isNotNull prepend="," property="couponGivetypeId" >
        COUPON_GIVETYPE_ID
      </isNotNull>
      <isNotNull prepend="," property="couponName" >
        COUPON_NAME
      </isNotNull>
      <isNotNull prepend="," property="couponDescribe" >
        COUPON_DESCRIBE
      </isNotNull>
      <isNotNull prepend="," property="couponMoney" >
        COUPON_MONEY
      </isNotNull>
      <isNotNull prepend="," property="starttime" >
        STARTTIME
      </isNotNull>
      <isNotNull prepend="," property="endtime" >
        ENDTIME
      </isNotNull>
      <isNotNull prepend="," property="createtime" >
        CREATETIME
      </isNotNull>
      <isNotNull prepend="," property="status" >
        STATUS
      </isNotNull>
      <isNotNull prepend="," property="customLeveid" >
        CUSTOM_LEVEID
      </isNotNull>
      <isNotNull prepend="," property="customRegStart" >
        CUSTOM_REG_START
      </isNotNull>
      <isNotNull prepend="," property="customRegEnd" >
        CUSTOM_REG_END
      </isNotNull>
      <isNotNull prepend="," property="payLeastMoney" >
        PAY_LEAST_MONEY
      </isNotNull>
      <isNotNull prepend="," property="customId" >
        CUSTOM_ID
      </isNotNull>
      <isNotNull prepend="," property="isGrant" >
        IS_GRANT
      </isNotNull>
      <isNotNull prepend="," property="couponValidDay" >
        COUPON_VALID_DAY
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(" >
      <isNotNull prepend="," property="couponId" >
        #couponId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="couponGivetypeId" >
        #couponGivetypeId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="couponName" >
        #couponName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponDescribe" >
        #couponDescribe:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponMoney" >
        #couponMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="starttime" >
        #starttime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="endtime" >
        #endtime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="createtime" >
        #createtime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="status" >
        #status:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="customLeveid" >
        #customLeveid:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="customRegStart" >
        #customRegStart:DATE#
      </isNotNull>
      <isNotNull prepend="," property="customRegEnd" >
        #customRegEnd:DATE#
      </isNotNull>
      <isNotNull prepend="," property="payLeastMoney" >
        #payLeastMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="customId" >
        #customId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="isGrant" >
        #isGrant:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponValidDay" >
        #couponValidDay:DECIMAL#
      </isNotNull>
      )
    </dynamic>
  </insert>
 
 
  
  <update id="ibatorgenerated_updateByPrimaryKeySelective" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    update COUPON
    <dynamic prepend="set" >
      <isNotNull prepend="," property="couponGivetypeId" >
        COUPON_GIVETYPE_ID = #couponGivetypeId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="couponName" >
        COUPON_NAME = #couponName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponDescribe" >
        COUPON_DESCRIBE = #couponDescribe:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponMoney" >
        COUPON_MONEY = #couponMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="starttime" >
        STARTTIME = #starttime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="endtime" >
        ENDTIME = #endtime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="createtime" >
        CREATETIME = #createtime:DATE#
      </isNotNull>
      <isNotNull prepend="," property="status" >
        STATUS = #status:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="customLeveid" >
        CUSTOM_LEVEID = #customLeveid:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="customRegStart" >
        CUSTOM_REG_START = #customRegStart:DATE#
      </isNotNull>
      <isNotNull prepend="," property="customRegEnd" >
        CUSTOM_REG_END = #customRegEnd:DATE#
      </isNotNull>
      <isNotNull prepend="," property="payLeastMoney" >
        PAY_LEAST_MONEY = #payLeastMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="customId" >
        CUSTOM_ID = #customId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="isGrant" >
        IS_GRANT = #isGrant:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponValidDay" >
        COUPON_VALID_DAY = #couponValidDay:DECIMAL#
      </isNotNull>
    </dynamic>
    where COUPON_ID = #couponId:DECIMAL#
  </update>
  <update id="ibatorgenerated_updateByPrimaryKey" parameterClass="com.kmzyc.b2b.model.Coupon" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Oct 10 09:28:38 CST 2013.
    -->
    update COUPON
    set COUPON_GIVETYPE_ID = #couponGivetypeId:DECIMAL#,
      COUPON_NAME = #couponName:VARCHAR#,
      COUPON_DESCRIBE = #couponDescribe:VARCHAR#,
      COUPON_MONEY = #couponMoney:DECIMAL#,
      STARTTIME = #starttime:DATE#,
      ENDTIME = #endtime:DATE#,
      CREATETIME = #createtime:DATE#,
      STATUS = #status:DECIMAL#,
      CUSTOM_LEVEID = #customLeveid:VARCHAR#,
      CUSTOM_REG_START = #customRegStart:DATE#,
      CUSTOM_REG_END = #customRegEnd:DATE#,
      PAY_LEAST_MONEY = #payLeastMoney:DECIMAL#,
      CUSTOM_ID = #customId:VARCHAR#,
      IS_GRANT = #isGrant:VARCHAR#,
      COUPON_VALID_DAY = #couponValidDay:DECIMAL#
    where COUPON_ID = #couponId:DECIMAL#
  </update>
  
  
  <!-- 分页查询 -->
  <select id="findCouponListByPage" parameterClass="pagination" resultMap="COUPON_GRANT_MAP">
		<![CDATA[
			SELECT * FROM ( SELECT a.*  ,ROWNUM RN FROM 
				(select   c.COUPON_ID,
                         c.COUPON_GIVETYPE_ID,
                         c.COUPON_NAME,
                         c.COUPON_DESCRIBE,
                         c.COUPON_MONEY,
                        
                         c.CREATETIME,
                         c.STATUS,
                         c.CUSTOM_LEVEID,
                         c.CUSTOM_REG_START,
                         c.CUSTOM_REG_END,
                         c.PAY_LEAST_MONEY,
                         c.IS_GRANT,
                         c.COUPON_VALID_DAY,
                         nvl(c.use_limits_type,'0') use_limits_type,
                         g.coupon_grant_id,
                         g.custom_id,
                         g.coupon_status,
                         g.grant_creattime,
                         g.GRANT_CRATEMAN,
                         g.grant_updatetime,
                         g.grant_updateman,
                         g.GRANT_TYPE,
                         g.GRANT_RELATED_CODE,
                         g.GRANT_REMARK,
                         g.GRANT_ENDTIME,
                         g.STARTTIME  as starttime_coupon,
                         g.ENDTIME  as endtime_coupon,
                         g.grant_acttime 
				   			from coupon                c,
				       			 coupon_grant          g 
				 				 where  
				   				 c.coupon_id = g.coupon_id 
		]]>
		<dynamic prepend="and">
			<include refid="byUserIdCondition" />
		</dynamic>
		<dynamic prepend="and">
			<include refid="byPageCondition" />
		</dynamic>
		<isNotNull property="objCondition.orderItem1">
			order by  endtime_coupon desc
		</isNotNull>
		<isNotNull property="objCondition.orderItem2">
			order by  coupon_status desc , grant_usetime desc   nulls last
		</isNotNull>
		<isNotNull property="objCondition.orderItem3">
			order by g.grant_acttime desc   nulls last
		</isNotNull>
		
		
		<!-- <isEqual property="orderItem"  compareValue="3"  >
			order by g.grant_creattime desc 
		</isEqual>
		<isEqual property="objCondition.orderItem"  compareValue="2"  >
			
		</isEqual>
		<isEqual property="objCondition.orderItem"  compareValue="1"  >
			order by  endtime_coupon desc
		</isEqual> -->
		) a WHERE 
		<![CDATA[
				ROWNUM <= #endindex#)
		]]>
		 WHERE RN >= #startindex# 
		
		
	</select>
	
	 <!-- 时代用户查询所有可用优惠券信息 -->
  <select id="findCouponList" parameterClass="java.lang.String" resultMap="COUPON_GRANT_MAP">
		<![CDATA[
			select   c.COUPON_ID,
                         c.COUPON_GIVETYPE_ID,
                         c.COUPON_NAME,
                         c.COUPON_DESCRIBE,
                         c.COUPON_MONEY,
                         c.CREATETIME,
                         c.STATUS,
                         c.CUSTOM_LEVEID,
                         c.CUSTOM_REG_START,
                         c.CUSTOM_REG_END,
                         c.PAY_LEAST_MONEY,
                         c.IS_GRANT,
                         c.COUPON_VALID_DAY,
                         nvl(c.use_limits_type,'0') use_limits_type,
                         g.coupon_grant_id,
                         g.custom_id,
                         g.coupon_status,
                         g.grant_creattime,
                         g.GRANT_CRATEMAN,
                         g.grant_updatetime,
                         g.grant_updateman,
                         g.GRANT_TYPE,
                         g.GRANT_RELATED_CODE,
                         g.GRANT_REMARK,
                         g.GRANT_ENDTIME,
                         g.STARTTIME  as starttime_coupon,
                         g.ENDTIME  as endtime_coupon,
                         g.grant_acttime 
				   			from coupon                c,
				       			 coupon_grant          g 
				 				 where  
				   				 c.coupon_id = g.coupon_id 
				   				 and exists (select 1 from era_info ei where ei.n_login_id=g.CUSTOM_ID and ei.era_no=upper(#eraNo:VARCHAR2(50)#) or ei.era_no= lower(#eraNo:VARCHAR2(50)#))
				   				 and g.coupon_status = 3 
				   				 and sysdate <=  g.ENDTIME
				   				 order by g.grant_acttime desc   nulls last
		]]>
		
		
	</select>
	
  
  <!-- 查询优惠券的总数目 -->
  <select id="countCouponByPage" parameterClass="pagination" resultClass="int">
        <![CDATA[
            select count(1)
              from  coupon c, coupon_grant g
             where	c.coupon_id = g.coupon_id
        ]]>
		<dynamic >
			<include refid="byPageCountCondition" />
		</dynamic>
	</select>

    <!-- 查询某用户下未使用的优惠券的总数目 -->
    <select id="countCouponByUserId" parameterClass="java.util.Map" resultClass="long">
        <![CDATA[
            select count(1)
              from  coupon c, coupon_grant g
              where	c.coupon_id = g.coupon_id
              and c.status in (1,2)
              and g.endtime>sysdate
         ]]>
         <isNotNull property="status" prepend="AND">
            g.coupon_status=#status:VARCHAR#
         </isNotNull>  
         <![CDATA[
              and g.CUSTOM_ID = #userId:VARCHAR#
        ]]>
    </select>
  	<select id="queryCouponGrantByCouponId" parameterClass="java.util.Map" resultMap="couponGrant">
  		   select * from coupon_grant where coupon_grant_id=#couponId# and custom_id=#loginId#
  	</select>
  	
  	<select id="queryCouponMoneyByCouponGrantId" parameterClass="long" resultMap="ibatorgenerated_BaseResultMap">
  		 select c.* from coupon_grant g, coupon c
    		where g.coupon_id = c.coupon_id and g.COUPON_GRANT_ID=#couponGrantId#
  	</select>
  	
  	<insert id="insertCouponIssuingSetting"  parameterClass="com.kmzyc.b2b.model.CouponIssuingSetting" >
  		<selectKey resultClass="java.lang.Long" keyProperty="couponIssuingId" >
           select SEQ_COUPON_ISSUING_SETTING.nextval from dual
    	</selectKey>
    	insert into COUPON_ISSUING_SETTING
    	<dynamic prepend="(" >
     		 <isNotNull prepend="," property="couponIssuingId" >
        		COUPON_ISSUING_ID
		      </isNotNull>
		      <isNotNull prepend="," property="couponId" >
		        COUPON_ID
		      </isNotNull>
		      <isNotNull prepend="," property="issuingStartTime" >
		        ISSUING_STARTTIME
		      </isNotNull>
		      <isNotNull prepend="," property="issuingEndTime" >
		        ISSUING_ENDTIME
		      </isNotNull>
		      <isNotNull prepend="," property="isStatus" >
		        IS_STATUS
		      </isNotNull>
		      <isNotNull prepend="," property="issuingCount" >
		        ISSUING_COUNT
		      </isNotNull>
		      <isNotNull prepend="," property="customLeveId" >
		        CUSTOM_LEVEID
		      </isNotNull>
		      <isNotNull prepend="," property="customId" >
		        CUSTOM_ID
		      </isNotNull>
		      <isNotNull prepend="," property="couponGivetypeId" >
		        COUPON_GIVETYPE_ID
		      </isNotNull>
		      <isNotNull prepend="," property="couponDesc" >
		        COUPON_DESC
		      </isNotNull>
		      )
		    </dynamic>
		    values
		    <dynamic prepend="(" >
		    <isNotNull prepend="," property="couponIssuingId" >
        		#couponIssuingId:DECIMAL#
		      </isNotNull>
		      <isNotNull prepend="," property="couponId" >
		        #couponId:DECIMAL#
		      </isNotNull>
		      <isNotNull prepend="," property="issuingStartTime" >
		         #issuingStartTime#
		      </isNotNull>
		      <isNotNull prepend="," property="issuingEndTime" >
		        #issuingEndTime#
		      </isNotNull>
		      <isNotNull prepend="," property="isStatus" >
		        #isStatus:DECIMAL#
		      </isNotNull>
		      <isNotNull prepend="," property="issuingCount" >
		        #issuingCount:DECIMAL#
		      </isNotNull>
		      <isNotNull prepend="," property="customLeveId" >
        		#customLeveId:VARCHAR#
      		  </isNotNull>
		      <isNotNull prepend="," property="customId" >
		        #customId:VARCHAR#
		      </isNotNull>
		      <isNotNull prepend="," property="couponGivetypeId" >
		        #couponGivetypeId:DECIMAL#
		      </isNotNull>
		      <isNotNull prepend="," property="couponDesc" >
		        #couponDesc:VARCHAR#
		      </isNotNull>
      )
    </dynamic>
  </insert>
  
  <insert id="insertCouponGrantFlow" parameterClass="com.kmzyc.b2b.model.CouponGrantFlow" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Thu Aug 22 09:45:29 CST 2013.
    -->
     <selectKey resultClass="java.lang.Long" keyProperty="couponGrantFlowId" >
           select SEQ_APP_COUPON_GRANT_FLOW.nextval from dual
    </selectKey>
    insert into coupon_grant_flow
    <dynamic prepend="(" >
      <isNotNull prepend="," property="couponGrantFlowId" >
        COUPON_GRANT_FLOW_ID
      </isNotNull>
      <isNotNull prepend="," property="couponGrantFlowType" >
        COUPON_GRANT_FLOW_TYPE
      </isNotNull>
      <isNotNull prepend="," property="operatingPerson" >
        OPERATING_PERSON
      </isNotNull>
      <isNotNull prepend="," property="createDate" >
        CREATE_DATE
      </isNotNull>
       <isNotNull prepend="," property="orderCode" >
       ORDER_CODE
      </isNotNull>
         <isNotNull prepend="," property="orderFlowCode" >
      ORDER_FLOW_CODE
      </isNotNull>
        <isNotNull prepend="," property="remark" >
      REMARK
      </isNotNull>
      <isNotNull prepend="," property="couponGrantId" >
       COUPON_GRANT_ID
      </isNotNull>
       <isNotNull prepend="," property="operatingPersonName" >
       OPERATING_PERSON_NAME
      </isNotNull>
      <isNotNull prepend="," property="couponId" >
       COUPON_ID
      </isNotNull>
       <isNotNull prepend="," property="couponName" >
       COUPON_NAME
      </isNotNull>
       <isNotNull prepend="," property="customId" >
       CUSTOM_ID
      </isNotNull>
       <isNotNull prepend="," property="customer" >
       CUSTOMER
      </isNotNull>
     
     
      )
    </dynamic>
    values
    <dynamic prepend="(" >
           <isNotNull prepend="," property="couponGrantFlowId" >
       #couponGrantFlowId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="couponGrantFlowType" >
        #couponGrantFlowType:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="operatingPerson" >
        #operatingPerson:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="createDate" >
       #createDate#
      </isNotNull>
       <isNotNull prepend="," property="orderCode" >
       #orderCode:VARCHAR#
      </isNotNull>
         <isNotNull prepend="," property="orderFlowCode" >
      #orderFlowCode:VARCHAR#
      </isNotNull>
        <isNotNull prepend="," property="remark" >
       #remark:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="couponGrantId" >
       #couponGrantId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="operatingPersonName" >
       #operatingPersonName:VARCHAR#
      </isNotNull>
       <isNotNull prepend="," property="couponId" >
       #couponId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="couponName" >
       #couponName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="customId" >
       #customId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="customer" >
       #customer:VARCHAR#
      </isNotNull>
     
      )
    </dynamic>
  </insert>
  <select id="youkuCouponGrantInfo" parameterClass="int" resultClass="java.util.HashMap"> 
	select cgi.ACTIVE_CODE,cgi.coupon_grant_id
  	from coupon_grant_info cgi
  	where cgi.coupon_grant_id = (select coupon_grant_id
                                from coupon_grant
                               where coupon_id = #coupon_id:NUMBER#
                                 and ACTIVE_CODE is null
                                 and act_status = 0
                                 and rownum = 1)
  	</select>
  <update id="ibatorgenerated_updateCouponGrantById" parameterClass="java.util.HashMap" > 
  update coupon_grant  cg set cg.active_code=#activeCode:VARCHAR# , cg.coupon_status=2  where cg.coupon_grant_id=#couponGrantId:NUMBER#
  </update>
  
  
  
</sqlMap>