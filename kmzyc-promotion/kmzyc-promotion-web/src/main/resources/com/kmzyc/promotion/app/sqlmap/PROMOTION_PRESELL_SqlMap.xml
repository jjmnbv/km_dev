<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="PROMOTION_PRESELL">
  <resultMap class="com.kmzyc.promotion.app.vobject.PromotionPresell" id="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri May 08 10:37:33 CST 2015.
    -->
    <result column="PRESELL_ID" jdbcType="DECIMAL" property="presellId" />
    <result column="PRESELL_TITLE" jdbcType="VARCHAR" property="presellTitle" />
    <result column="SHOP_SORT" jdbcType="DECIMAL" property="shopSort" />
    <result column="SUPPLIER_ID" jdbcType="DECIMAL" property="supplierId" />
    <result column="PRESELL_STATUS" jdbcType="DECIMAL" property="presellStatus"/>
    <result column="AUDIT_STATUS" jdbcType="DECIMAL" property="auditStatus" />
    <result column="INITIAL_PRESELL_NUM" jdbcType="DECIMAL" property="initialPresellNum" />
    <result column="BUY_LIMIT" jdbcType="DECIMAL" property="byLimit" />
    <result column="DEPOSIT_START_TIME" jdbcType="TIMESTAMP" property="depositStartTime" />
    <result column="DEPOSIT_END_TIME" jdbcType="TIMESTAMP" property="depositEndTime" />
    <result column="FINALPAY_START_TIME" jdbcType="TIMESTAMP" property="finalpayStartTime" />
    <result column="FINALPAY_END_TIME" jdbcType="TIMESTAMP" property="finalpayEndTime"/>
	<result column="DELIVERY_START_TIME" jdbcType="TIMESTAMP" property="deliveryStartTime" />
	<result column="DELIVERY_END_TIME" jdbcType="TIMESTAMP" property="deliveryEndTime" />
	<result column="PRESELL_DESCRIBE" jdbcType="VARCHAR" property="presellDescribe" />
	<result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
	<result column="MODIFY_TIME" jdbcType="TIMESTAMP" property="modifyTime" />
	<result column="CREATE_USER" jdbcType="DECIMAL"  property="createUser" />
	<result column="MODIF_USER" jdbcType="DECIMAL"  property="modifUser" />	
	<result column="corporate_name" jdbcType="VARCHAR" property="corporateName" />					
  </resultMap>
  
  <resultMap class="com.kmzyc.promotion.app.vobject.PromotionPresell" id="presellInfoDetailResultMap">
    <result column="PRESELL_ID" jdbcType="DECIMAL" property="presellId" />
    <result column="PRESELL_TITLE" jdbcType="VARCHAR" property="presellTitle" />
    <result column="SHOP_SORT" jdbcType="DECIMAL" property="shopSort" />
    <result column="SUPPLIER_ID" jdbcType="DECIMAL" property="supplierId" />
    <result column="INITIAL_PRESELL_NUM" jdbcType="DECIMAL" property="initialPresellNum" />
    <result column="BUY_LIMIT" jdbcType="DECIMAL" property="byLimit" />
    <result column="DEPOSIT_START_TIME" jdbcType="TIMESTAMP" property="depositStartTime" />
    <result column="DEPOSIT_END_TIME" jdbcType="TIMESTAMP" property="depositEndTime" />
    <result column="FINALPAY_START_TIME" jdbcType="TIMESTAMP" property="finalpayStartTime" />
    <result column="FINALPAY_END_TIME" jdbcType="TIMESTAMP" property="finalpayEndTime"/>
	<result column="DELIVERY_START_TIME" jdbcType="TIMESTAMP" property="deliveryStartTime" />
	<result column="DELIVERY_END_TIME" jdbcType="TIMESTAMP" property="deliveryEndTime" />
	<result column="PRESELL_DESCRIBE" jdbcType="VARCHAR" property="presellDescribe" />
	<result column="corporate_name" jdbcType="VARCHAR" property="corporateName" />
	<result column="audit_status" jdbcType="VARCHAR" property="auditStatus" />
	<result column="PRESELL_ID" property="listPresellProduct" select="PROMOTION_PRESELL.selectPresellProductList" />	
  </resultMap>
  
   <resultMap class="com.kmzyc.promotion.app.vobject.PromotionPresellProduct" id="presellProductMap">
    <result column="PRESELL_PRODUCT_ID" jdbcType="DECIMAL" property="presellProductId" />
    <result column="PRODUCT_SKU_ID" jdbcType="DECIMAL" property="productSkuId" />
    <result column="PRESELL_PRICE" jdbcType="DECIMAL" property="presellPrice" />
    <result column="DEPOSIT_PRICE" jdbcType="DECIMAL" property="depositPrice"/>
    <result column="FINAL_PRICE" jdbcType="DECIMAL" property="finalPrice" />
    <result column="presell_stock" jdbcType="DECIMAL" property="presellStock" />
    <result column="product_title" jdbcType="VARCHAR" property="productTitle" />
    <result column="brand_name" jdbcType="VARCHAR" property="brandName" />
    <result column="product_sku_code" jdbcType="VARCHAR" property="productSkuCode" />
    <result column="price" jdbcType="DECIMAL" property="price" />
    <result column="stock" jdbcType="DECIMAL" property="stock" />
  </resultMap>
  

		<!-- 查询预售审核信息-->
  <select id="queryAuditPresellList" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria" resultMap="ibatorgenerated_BaseResultMap">
  SELECT * FROM(
    		SELECT T.*,ROWNUM RN FROM (SELECT pp.PRESELL_ID,
		       pp.PRESELL_TITLE,
		       pp.SHOP_SORT,
		       decode(pp.shop_sort,
                1,
                '康美自营代销',
                2,
                (select ctbi.corporate_name
                   from suppliers_info                      sinfo,
                        commercial_tenant_basic_info ctbi
                  where pp.supplier_id = sinfo.supplier_id
                    and sinfo.merchant_id = ctbi.n_commercial_tenant_id
                    and sinfo.status = 3)) corporate_name,
		       pp.SUPPLIER_ID,
		        <![CDATA[
	           case 
	             when pp.PRESELL_STATUS=3 then 3
	             when pp.DEPOSIT_START_TIME<=sysdate and  pp.DEPOSIT_END_TIME>sysdate and pp.AUDIT_STATUS=1  then 4 
	             when pp.DEPOSIT_END_TIME<=sysdate and  pp.FINALPAY_START_TIME>sysdate and pp.AUDIT_STATUS=1 then 5    
	             when pp.FINALPAY_START_TIME<=sysdate and  pp.FINALPAY_END_TIME>sysdate and pp.AUDIT_STATUS=1 then 6
	             when pp.FINALPAY_END_TIME<sysdate and pp.AUDIT_STATUS=1  then 7
	             else pp.PRESELL_STATUS]]>
	           end PRESELL_STATUS,
		       pp.AUDIT_STATUS,
		       pp.INITIAL_PRESELL_NUM,
		       pp.BUY_LIMIT,
		       pp.DEPOSIT_START_TIME,
		       pp.DEPOSIT_END_TIME,
		       pp.FINALPAY_START_TIME,
		       pp.FINALPAY_END_TIME,
		       pp.DELIVERY_START_TIME,
		       pp.DELIVERY_END_TIME,
		       pp.PRESELL_DESCRIBE,
		       pp.CREATE_TIME,
		       pp.MODIFY_TIME,
		       pp.CREATE_USER,
		       pp.MODIF_USER
		  FROM PROMOTION_PRESELL pp
		  
		   where 1=1
		   and  exists(
                 select 1 from  
                 PROMOTION_PRESELL_PRODUCT ppp
                  left join product_sku sku
                  on sku.product_sku_id = ppp.product_sku_id
                  left join productmain p
                  on sku.product_id = p.product_id
                 where ppp.PRESELL_ID =pp.PRESELL_ID
                 <isNotEmpty  prepend="and" property="productTitle">
	     			p.product_title like  '%'||#productTitle#||'%'
	      		 </isNotEmpty >
	      		 <isNotEmpty  prepend="and" property="productNO">
	     			 p.product_no  =#productNO#
	      		 </isNotEmpty >
           )
		   
		   and pp.PRESELL_STATUS!=0
	      <isNotEmpty  prepend="and" property="presellTitle">
	     	pp.PRESELL_TITLE like '%'||#presellTitle#||'%'
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="presellId">
	     	pp.PRESELL_ID = #presellId#
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="auditStatus">
	     <isNotEqual property="auditStatus" compareValue="9">
	     	pp.AUDIT_STATUS =#auditStatus#
	     </isNotEqual>
	     </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime">
	     	<![CDATA[ pp.DEPOSIT_START_TIME > #payTime#  ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime2">
	     	<![CDATA[ pp.FINALPAY_END_TIME < #payTime2# ]]>
	      </isNotEmpty >
      
		   order by pp.PRESELL_ID desc)T WHERE   <![CDATA[ ROWNUM<= #endIndex# ]]>
		   <isNotEmpty  property="presellStatus">
		   <isNotEqual property="presellStatus" compareValue="9">
	     	 and PRESELL_STATUS =#presellStatus#
	     	 </isNotEqual>
	       </isNotEmpty >
		   )  WHERE  <![CDATA[RN > #startIndex# ]]>
  </select>
  
  	<!-- 查询预售审核信息-->
  <select id="queryAuditPresellCount" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria" resultClass="java.lang.Integer">

    select  count(PRESELL_STATUS) from (
	    SELECT 
	           <![CDATA[
	          case
	             when pp.PRESELL_STATUS = 3 then
	              3
	             when pp.DEPOSIT_START_TIME <= sysdate and
	                  pp.DEPOSIT_END_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              4
	             when pp.DEPOSIT_END_TIME <= sysdate and
	                  pp.FINALPAY_START_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              5
	             when pp.FINALPAY_START_TIME <= sysdate and
	                  pp.FINALPAY_END_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              6
	             when pp.FINALPAY_END_TIME < sysdate and pp.AUDIT_STATUS = 1 then
	              7
	             else
	              pp.PRESELL_STATUS 
	              ]]>
	           end PRESELL_STATUS 
	      FROM PROMOTION_PRESELL pp
	      
		   where 1=1
		   and  exists(
                 select 1 from  
                 PROMOTION_PRESELL_PRODUCT ppp
                  left join product_sku sku
                  on sku.product_sku_id = ppp.product_sku_id
                  left join productmain p
                  on sku.product_id = p.product_id
                 where ppp.PRESELL_ID =pp.PRESELL_ID
                 <isNotEmpty  prepend="and" property="productTitle">
	     			p.product_title like  '%'||#productTitle#||'%'
	      		 </isNotEmpty >
	      		 <isNotEmpty  prepend="and" property="productNO">
	     			 p.product_no  =#productNO#
	      		 </isNotEmpty >
           )
		   
		   and pp.PRESELL_STATUS!=0
	      <isNotEmpty  prepend="and" property="presellTitle">
	     	pp.PRESELL_TITLE like '%'||#presellTitle#||'%'
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="presellId">
	     	pp.PRESELL_ID = #presellId#
	      </isNotEmpty >
	       <isNotEmpty  prepend="and" property="payTime">
	     	<![CDATA[ pp.DEPOSIT_START_TIME > #payTime#  ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime2">
	     	<![CDATA[ pp.FINALPAY_END_TIME < #payTime2# ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="auditStatus">
	     <isNotEqual property="auditStatus" compareValue="9">
	     	pp.AUDIT_STATUS =#auditStatus#
	     </isNotEqual>
	     </isNotEmpty >
	      ) where 	 1= 1    
		   <isNotEmpty  property="presellStatus">
		   <isNotEqual property="presellStatus" compareValue="9">
	     	 and PRESELL_STATUS =#presellStatus#
	     	 </isNotEqual>
	       </isNotEmpty >
    </select>
    
  <!--更新预售审核信息-->
  <update id="updateAuditPresell" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria" >
  	    update PROMOTION_PRESELL
    <dynamic prepend="set">
      <isNotEmpty  prepend="," property="presellStatus">
        PRESELL_STATUS = #presellStatus:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="auditStatus">
        AUDIT_STATUS = #auditStatus:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="presellId">
        MODIFY_TIME = sysdate
      </isNotEmpty >
      <isNotEmpty  prepend="," property="modifUser">
        MODIF_USER = #modifUser:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="presellId">
        AUDIT_TIME = sysdate
      </isNotEmpty >
      <isNotEmpty  prepend="," property="modifUser">
        AUDIT_USER = #modifUser:DECIMAL#
      </isNotEmpty >
    </dynamic>
 		where PRESELL_ID = #presellId:DECIMAL# and PRESELL_STATUS=1
  </update>
  
 <resultMap class="com.kmzyc.promotion.app.vobject.PromotionPresell" id="ibatorgenerated_BaseResult">
	<result column="PRODUCT_SKU_ID" jdbcType="DECIMAL"  property="productSkuId" />
	<result column="PRESELL_PRICE" jdbcType="DECIMAL"  property="presellPrice" />
	<result column="FINAL_PRICE" jdbcType="DECIMAL"  property="finalPrice" />
	<result column="DEPOSIT_PRICE" jdbcType="DECIMAL"  property="depositPrice" />
	<result column="product_sku_code" jdbcType="VARCHAR"  property="productSkuCode" />
	<result column="product_title" jdbcType="VARCHAR"  property="productTitle" />
	<result column="product_no" jdbcType="VARCHAR"  property="productNo" />
	<result column="PRESELL_ID" jdbcType="DECIMAL" property="presellId" />	
	<result column="PRESELL_STOCK" jdbcType="DECIMAL" property="presellStock" />			
	<result column="STOCK" jdbcType="DECIMAL" property="stock" />
	<result column="BRAND_NAME" jdbcType="DECIMAL" property="brandName" />	
	<result column="PRICE" jdbcType="DECIMAL" property="price" />	
				
  </resultMap>
  
  	<!-- 查询预售商品详情 -->
  <select id="queryProductDetailList" parameterClass="java.util.List" resultMap="ibatorgenerated_BaseResult">
      SELECT distinct ppp.PRODUCT_SKU_ID,
             ppp.PRESELL_PRICE,
             ppp.DEPOSIT_PRICE,
             sku.product_sku_code,
             p.product_title,
             p.product_no,
             ppp.PRESELL_ID,
             ppp.FINAL_PRICE,
             ppp.PRESELL_STOCK,
             pb.BRAND_NAME,
             sku.PRICE,
			nvl((max(ps.stock_quality -
           decode(sign(ps.order_quality - 0), -1, 0, ps.order_quality)) over(partition by ps.sku_attribute_id)),0) stock
        FROM PROMOTION_PRESELL_PRODUCT ppp
        left join product_sku sku
          on sku.product_sku_id = ppp.product_sku_id
        left join productmain p
          on sku.product_id = p.product_id
        left join  prod_brand 				  pb
          on p.brand_id=pb.brand_id
        left join  product_stock ps
         on sku.product_sku_id = ps.sku_attribute_id
       where  ppp.PRESELL_ID in
		 <iterate conjunction="," open="(" close=")">
            #map[].presellId#
        </iterate>
  </select>
  
  
  	<!--根据presellId 查询 skuid列表-->
  <select id="querySkuidsByPresellId" parameterClass="java.lang.Long" resultClass="java.lang.Long">
      SELECT ppp.PRODUCT_SKU_ID
      FROM PROMOTION_PRESELL_PRODUCT ppp
      where  ppp.PRESELL_ID = #presellId:DECIMAL# 
  </select>
  
  	<!--查询需要自动结束的活动id  presellId列表(2天内为处理过的数据,排除手动终止的活动)-->
  <select id="queryPresellIdForAutoStop"  resultClass="java.lang.Long">
      <![CDATA[
      SELECT pp.PRESELL_ID
      FROM PROMOTION_PRESELL pp
      where  pp.FINALPAY_END_TIME>sysdate-2
      and pp.FINALPAY_END_TIME <= sysdate
      and pp.AUTOSTOP_FLAG <>1
      and pp.AUDIT_STATUS =1
      and pp.PRESELL_STATUS <>3
      ]]>
  </select>
  
   
  <!-- 查询预售商品信息-->
  <select id="queryPresellManagerList" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria" resultMap="ibatorgenerated_BaseResultMap">
  SELECT * FROM(
    		SELECT T.*,ROWNUM RN FROM (SELECT pp.PRESELL_ID,
		       pp.PRESELL_TITLE,
		       pp.SHOP_SORT,
		       decode(pp.shop_sort,
                1,
                '康美自营代销',
                2,
                (select ctbi.corporate_name
                   from suppliers_info                      sinfo,
                        commercial_tenant_basic_info ctbi
                  where pp.supplier_id = sinfo.supplier_id
                    and sinfo.merchant_id = ctbi.n_commercial_tenant_id
                    and sinfo.status = 3)) corporate_name,
		       pp.SUPPLIER_ID,
		        <![CDATA[
	           case 
	             when pp.PRESELL_STATUS=3 then 3
	             when pp.DEPOSIT_START_TIME<=sysdate and  pp.DEPOSIT_END_TIME>sysdate and pp.AUDIT_STATUS=1  then 4 
	             when pp.DEPOSIT_END_TIME<=sysdate and  pp.FINALPAY_START_TIME>sysdate and pp.AUDIT_STATUS=1 then 5    
	             when pp.FINALPAY_START_TIME<=sysdate and  pp.FINALPAY_END_TIME>sysdate and pp.AUDIT_STATUS=1 then 6
	             when pp.FINALPAY_END_TIME<sysdate and pp.AUDIT_STATUS=1  then 7
	             else pp.PRESELL_STATUS]]>
	           end PRESELL_STATUS,
		       pp.AUDIT_STATUS,
		       pp.INITIAL_PRESELL_NUM,
		       pp.BUY_LIMIT,
		       pp.DEPOSIT_START_TIME,
		       pp.DEPOSIT_END_TIME,
		       pp.FINALPAY_START_TIME,
		       pp.FINALPAY_END_TIME,
		       pp.DELIVERY_START_TIME,
		       pp.DELIVERY_END_TIME,
		       pp.PRESELL_DESCRIBE,
		       pp.CREATE_TIME,
		       pp.MODIFY_TIME,
		       pp.CREATE_USER,
		       pp.MODIF_USER
		  FROM PROMOTION_PRESELL pp
		   where 1=1
		   and  exists(
                 select 1 from  
                 PROMOTION_PRESELL_PRODUCT ppp
                  left join product_sku sku
                  on sku.product_sku_id = ppp.product_sku_id
                  left join productmain p
                  on sku.product_id = p.product_id
                 where ppp.PRESELL_ID =pp.PRESELL_ID
                 <isNotEmpty  prepend="and" property="productTitle">
	     			p.product_title like  '%'||#productTitle#||'%'
	      		 </isNotEmpty >
	      		 <isNotEmpty  prepend="and" property="productNO">
	     			 p.product_no  =#productNO#
	      		 </isNotEmpty >
           )
	      <isNotEmpty  prepend="and" property="presellTitle">
	     	pp.PRESELL_TITLE like '%'||#presellTitle#||'%'
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="presellId">
	     	pp.PRESELL_ID = #presellId#
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="auditStatus">
	     <isNotEqual property="auditStatus" compareValue="9">
	     	pp.AUDIT_STATUS =#auditStatus#
	     </isNotEqual>
	     </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime">
	     	<![CDATA[ pp.DEPOSIT_START_TIME > #payTime#  ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime2">
	     	<![CDATA[ pp.FINALPAY_END_TIME < #payTime2# ]]>
	      </isNotEmpty >
      
		   order by pp.PRESELL_ID desc )T WHERE   <![CDATA[ ROWNUM<= #endIndex# ]]>
		   <isNotEmpty  property="presellStatus">
		   <isNotEqual property="presellStatus" compareValue="9">
	     	 and PRESELL_STATUS =#presellStatus#
	     	 </isNotEqual>
	       </isNotEmpty >
		   )  WHERE  <![CDATA[RN > #startIndex# ]]>
  </select>
  
  	<!-- 查询预售商品信息-->
  <select id="queryPresellManagerCount" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria" resultClass="java.lang.Integer">
 select  count(PRESELL_STATUS) from (
	    SELECT 
	           <![CDATA[
	          case
	             when pp.PRESELL_STATUS = 3 then
	              3
	             when pp.DEPOSIT_START_TIME <= sysdate and
	                  pp.DEPOSIT_END_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              4
	             when pp.DEPOSIT_END_TIME <= sysdate and
	                  pp.FINALPAY_START_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              5
	             when pp.FINALPAY_START_TIME <= sysdate and
	                  pp.FINALPAY_END_TIME > sysdate and pp.AUDIT_STATUS = 1 then
	              6
	             when pp.FINALPAY_END_TIME < sysdate and pp.AUDIT_STATUS = 1 then
	              7
	             else
	              pp.PRESELL_STATUS 
	              ]]>
	           end PRESELL_STATUS 
	      FROM PROMOTION_PRESELL pp
	      
		   where 1=1
		   and  exists(
                 select 1 from  
                 PROMOTION_PRESELL_PRODUCT ppp
                  left join product_sku sku
                  on sku.product_sku_id = ppp.product_sku_id
                  left join productmain p
                  on sku.product_id = p.product_id
                 where ppp.PRESELL_ID =pp.PRESELL_ID
                 <isNotEmpty  prepend="and" property="productTitle">
	     			p.product_title like  '%'||#productTitle#||'%'
	      		 </isNotEmpty >
	      		 <isNotEmpty  prepend="and" property="productNO">
	     			 p.product_no  =#productNO#
	      		 </isNotEmpty >
           )
		   
	      <isNotEmpty  prepend="and" property="presellTitle">
	     	pp.PRESELL_TITLE like '%'||#presellTitle#||'%'
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="presellId">
	     	pp.PRESELL_ID = #presellId#
	      </isNotEmpty >
	       <isNotEmpty  prepend="and" property="payTime">
	     	<![CDATA[ pp.DEPOSIT_START_TIME > #payTime#  ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="payTime2">
	     	<![CDATA[ pp.FINALPAY_END_TIME < #payTime2# ]]>
	      </isNotEmpty >
	     <isNotEmpty  prepend="and" property="auditStatus">
	     <isNotEqual property="auditStatus" compareValue="9">
	     	pp.AUDIT_STATUS =#auditStatus#
	     </isNotEqual>
	     </isNotEmpty >
	      ) where 	 1= 1    
		   <isNotEmpty  property="presellStatus">
		   <isNotEqual property="presellStatus" compareValue="9">
	     	 and PRESELL_STATUS =#presellStatus#
	     	 </isNotEqual>
	       </isNotEmpty >  
    </select>
  
  <!--修改预售活动信息，用于（ 终止预售活动、提审预售活动） -->
  <update id="updatePresellManager" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresellCriteria">
		update PROMOTION_PRESELL 
	<dynamic prepend="set">
      <isNotEmpty  prepend="," property="presellStatus">
        PRESELL_STATUS = #presellStatus:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="presellId">
        MODIFY_TIME = sysdate
      </isNotEmpty >
      <isNotEmpty  prepend="," property="modifUser">
        MODIF_USER = #modifUser:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="autoStopFlag">
        AUTOSTOP_FLAG = #autoStopFlag:DECIMAL#
      </isNotEmpty >
    </dynamic>
    where PRESELL_ID = #presellId:DECIMAL#
  </update>
  
  <!-- 删除预售活动 -->
  <delete id="deletePresellInfo" parameterClass="java.lang.Long">
  		delete from PROMOTION_PRESELL
  		where PRESELL_ID = #presellId:DECIMAL#  
  </delete>
  <!-- 删除预售活动商品 -->
  <delete id="deletePresellProduct" parameterClass="java.lang.Long">
  		delete from PROMOTION_PRESELL_PRODUCT
  		where PRESELL_ID = #presellId:DECIMAL#  
  </delete>
  
  
  
  <!-- 新增预售规则 -->
  <insert id="insertPresellRule" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresell" >
  	<selectKey resultClass="java.lang.Long"  keyProperty="presellId" >
  		select SEQ_APP_PRESELL.nextval from dual
    </selectKey>
    insert into promotion_presell (PRESELL_ID,PRESELL_TITLE,SHOP_SORT,SUPPLIER_ID,PRESELL_STATUS,AUDIT_STATUS,
	  CREATE_TIME,CREATE_USER) values (#presellId:DECIMAL#,#presellTitle:VARCHAR#,#shopSort:DECIMAL#,#supplierId:DECIMAL#,
	  #presellStatus:DECIMAL#,#auditStatus:DECIMAL#,sysdate,#createUser:DECIMAL#)
  </insert>
  
   <select id="findPresellInfoDetailById" resultMap="presellInfoDetailResultMap" parameterClass="java.lang.Long">
    select pp.presell_id,
         pp.presell_title,
         pp.shop_sort,
         pp.supplier_id,
         pp.initial_presell_num,
         pp.buy_limit,
         pp.deposit_start_time,
         pp.deposit_end_time,
         pp.finalpay_start_time,
         pp.finalpay_end_time,
         pp.delivery_start_time,
         pp.delivery_end_time,
         pp.presell_describe,
         decode(pp.shop_sort,
                1,
                '康美自营代销',
                2,
                (select ctbi.corporate_name
                   from suppliers_info                      sinfo,
                        commercial_tenant_basic_info ctbi
                  where pp.supplier_id = sinfo.supplier_id
                    and sinfo.merchant_id = ctbi.n_commercial_tenant_id
                    and sinfo.status = 3)) corporate_name,
          pp.audit_status
	    from promotion_presell pp
	   where pp.presell_id =  #presellId:DECIMAL#  
  </select>
  
  <select id="selectPresellProductList" resultMap="presellProductMap" parameterClass="java.lang.Long">
     select distinct preproduct.presell_product_id,
	        preproduct.product_sku_id,
	        preproduct.presell_price,
	        preproduct.deposit_price,
	        preproduct.final_price,
	        preproduct.presell_stock,
	        pm.product_title,
	        pb.brand_name,
	        sku.product_sku_code,
	        sku.price,
	        nvl((max(ps.stock_quality -
          	 decode(sign(ps.order_quality - 0), -1, 0, ps.order_quality)) over(partition by ps.sku_attribute_id)),0) stock
	   from promotion_presell_product preproduct,
	        product_sku               sku,
	        productmain               pm,
	        product_stock             ps,
	        prod_brand 				  pb
	  where preproduct.product_sku_id = sku.product_sku_id
	    and sku.product_id = pm.product_id
	    and pm.brand_id=pb.brand_id
	    and sku.product_sku_id = ps.sku_attribute_id(+)
	    and preproduct.presell_id =  #presellId:DECIMAL#  
  </select>
  
   <!--更新预售规则信息-->
  <update id="updatePresellRule" parameterClass="com.kmzyc.promotion.app.vobject.PromotionPresell" >
  	    update PROMOTION_PRESELL
    <dynamic prepend="set">
      <isNotEmpty  prepend="," property="initialPresellNum">
        INITIAL_PRESELL_NUM = #initialPresellNum:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="byLimit">
        BUY_LIMIT = #byLimit:DECIMAL#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="depositStartTime">
        DEPOSIT_START_TIME = #depositStartTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="depositEndTime">
        DEPOSIT_END_TIME = #depositEndTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="finalpayStartTime">
        FINALPAY_START_TIME = #finalpayStartTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="finalpayEndTime">
        FINALPAY_END_TIME = #finalpayEndTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="deliveryStartTime">
        DELIVERY_START_TIME = #deliveryStartTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="deliveryEndTime">
        DELIVERY_END_TIME = #deliveryEndTime:java.util.DATE#
      </isNotEmpty >
       <isNotEmpty  prepend="," property="presellDescribe">
        PRESELL_DESCRIBE = #presellDescribe:VARCHAR#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="presellId">
        MODIFY_TIME = sysdate
      </isNotEmpty >
      <isNotEmpty  prepend="," property="modifUser">
        MODIF_USER = #modifUser:DECIMAL#
      </isNotEmpty >
      <isNotEmpty  prepend="," property="auditStatus">
        audit_status = #auditStatus:DECIMAL#
      </isNotEmpty >
    </dynamic>
 		where PRESELL_ID = #presellId:DECIMAL#
  </update>
  
  
   <!--修改预售库存（已售数量），每次自增count-->
  <update id="addPreselledCount" parameterClass="java.util.Map" >
	   update
	   PROMOTION_PRESELL_PRODUCT ppp 
	   set ppp.PRESELL_SELL = PRESELL_SELL + #count:DECIMAL#
	   where ppp.PRESELL_ID = #presellId:DECIMAL#
	   and ppp.PRODUCT_SKU_ID = #skuid:DECIMAL#
  </update>
  
  
     <!--撤销审批（改为草稿状态）-->
  <update id="cancelPresellApply" parameterClass="java.lang.Long" >
		update
		PROMOTION_PRESELL pp
		set pp.PRESELL_STATUS = 0
		where pp.PRESELL_ID =#presellId:DECIMAL#
  </update>
  
  <!-- 根据skuid，查询正在进行的促销活动总数 -->
	<select id="queryPromotionCountBySkuid" parameterClass="java.lang.Long" resultClass="java.lang.Integer">
		<![CDATA[ 
		select count(p.promotion_id)
		 from promotion p
		 where 1 = 1
		   and sysdate between p.start_time and p.end_time
		   and p.nature = 1
		   and p.status = 2
   		   and (p.promotion_type = 8 or p.promotion_type = 10)
		   and p.promotion_id in
		       (SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (SELECT ',' || PDM.Category_Id || ',' as categoryId
		                  FROM PRODUCT_SKU PSKU
		                 INNER JOIN PRODUCTMAIN PDM ON PSKU.PRODUCT_ID =
		                                               PDM.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 WHERE PSKU.product_sku_id = #skuid:DECIMAL#
		                   and (s.supplier_type = 1 or s.supplier_type = 3)) SINFO
		         WHERE PM.NATURE = '1'
		           AND PM.PRODUCT_FILTER_TYPE = '3'
		           AND instr(',' || PM.PRODUCT_FILTER_SQL, SINFO.categoryId) > 0
		           AND pm.shop_sort = '3'
		        UNION
		        SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (SELECT ',' || PDM.Category_Id || ',' as categoryId,
		                       s.supplier_id,
		                       s.supplier_type
		                  FROM PRODUCT_SKU PSKU
		                 INNER JOIN PRODUCTMAIN PDM ON PSKU.PRODUCT_ID =
		                                               PDM.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 WHERE PSKU.product_sku_id = #skuid:DECIMAL#) SINFO
		         WHERE PM.NATURE = '1'
		           AND PM.PRODUCT_FILTER_TYPE = '3'
		           AND instr(',' || PM.PRODUCT_FILTER_SQL, SINFO.categoryId) > 0
		           and pm.shop_sort = sinfo.supplier_type
		           and pm.supplier_id = sinfo.supplier_id
		           AND pm.shop_sort = '2'
		        UNION
		        SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (SELECT ',' || PDM.BRAND_ID || ',' as brandId
		                  FROM PRODUCT_SKU PSKU
		                 INNER JOIN PRODUCTMAIN PDM ON PSKU.PRODUCT_ID =
		                                               PDM.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 WHERE PSKU.product_sku_id = #skuid:DECIMAL#
		                   and (s.supplier_type = 1 or s.supplier_type = 3)) SINFO
		         WHERE PM.NATURE = '1'
		           AND PM.PRODUCT_FILTER_TYPE = '4'
		           AND instr(',' || PM.PRODUCT_FILTER_SQL, SINFO.brandId) > 0
		           AND pm.shop_sort = '3'
		        UNION
		        SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (SELECT ',' || PDM.BRAND_ID || ',' as brandId,
		                       s.supplier_id,
		                       s.supplier_type
		                  FROM PRODUCT_SKU PSKU
		                 INNER JOIN PRODUCTMAIN PDM ON PSKU.PRODUCT_ID =
		                                               PDM.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 WHERE PSKU.product_sku_id = #skuid:DECIMAL#) SINFO
		         WHERE PM.NATURE = '1'
		           AND PM.PRODUCT_FILTER_TYPE = '4'
		           AND instr(',' || PM.PRODUCT_FILTER_SQL, SINFO.brandId) > 0
		           and pm.shop_sort = sinfo.supplier_type
		           and pm.supplier_id = sinfo.supplier_id
		           AND pm.shop_sort = '2'
		        UNION
		        SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (select s.*
		                  from PRODUCT_SKU sku
		                 inner join PRODUCTMAIN pdm on pdm.PRODUCT_ID =
		                                               sku.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 where sku.product_sku_id = #skuid:DECIMAL#) SINFO
		         WHERE PM.NATURE = '1'
		           and (sinfo.supplier_type = 1 or sinfo.supplier_type = 3)
		           and PM.SHOP_SORT = 3
		           AND PM.PRODUCT_FILTER_TYPE = '1'
		        UNION
		        SELECT PM.promotion_id
		          FROM PROMOTION PM,
		               (select s.*
		                  from PRODUCT_SKU sku
		                 inner join PRODUCTMAIN pdm on pdm.PRODUCT_ID =
		                                               sku.PRODUCT_ID
		                 inner join suppliers_info s on to_char(s.supplier_id) =
		                                                pdm.SHOP_CODE
		                 where sku.product_sku_id = #skuid:DECIMAL#) SINFO
		         WHERE PM.NATURE = '1'
		           AND PM.SHOP_SORT = SINFO.SUPPLIER_TYPE
		           AND PM.SUPPLIER_ID = SINFO.SUPPLIER_ID
		           and PM.SHOP_SORT = 2
		           AND PM.PRODUCT_FILTER_TYPE = '1'
		        UNION
		        select PM.promotion_id
		          from PROMOTION PM, promotion_product pp, product_sku ps
		         where PM.NATURE = '1'
		           and ps.product_sku_id = #skuid:DECIMAL#
		           and pm.promotion_id = pp.promotion_id
		           and pp.product_sku_id = ps.product_sku_id)
		 		order by p.createtime desc
		]]>
	</select>
	
	<!-- 根据skuid，查询商品价格 -->
	<select id="queryProductPriceBySkuid" parameterClass="java.lang.Long" resultClass="java.lang.Double">
		select ps.PRICE from product_sku ps
		where ps.PRODUCT_SKU_ID = #skuid:DECIMAL#
	</select>
	
	<!-- 根据skuid，查询商品状态 -->
	<select id="queryProductStatusBySkuid" parameterClass="java.lang.Long" resultClass="java.lang.String">
		select pm.status from 
		product_sku ps
		left join productMain pm
		on ps.product_id = pm.product_id
		where ps.PRODUCT_SKU_ID = #skuid:DECIMAL#
	</select>
	
	<!-- 询正在参加的预售商品及参加了商家活动中心报名（促销推广、图文推广、渠道推广）的商品 -->
	<select id="selectPresellAndActivityProductCount" parameterClass="java.util.List" resultClass="java.lang.Integer">
		select count(1) from                          
		(select asku.product_sku_id
		  from activity_info ai, activity_supplier_entry ase, activity_sku asku
		 where ai.activity_id = ase.activity_id
		   and ase.supplier_entry_id = asku.supplier_entry_id
		   and ai.activity_end_time >= sysdate
		   and ai.activity_status not in (0, 1, 7, 8)
		   and ai.audit_status = 1
		   and ase.entry_status = 2
		   and ase.audit_status = 1
		   and asku.activity_sku_type = 1
		   and asku.audit_status = 1
		   and asku.product_sku_id in   
		   <iterate open="(" close=")" conjunction=",">  
				<![CDATA[#[]#]]>
			</iterate>
		union all
		select pdt.product_sku_id
		  from promotion_presell pre, promotion_presell_product pdt
		 where pre.presell_id = pdt.presell_id
		   and pre.audit_status = 1
		   and pre.presell_status !=3
		   and sysdate between pre.deposit_start_time and pre.finalpay_end_time
		   and pdt.product_sku_id in  
		 	<iterate open="(" close=")" conjunction=",">  
				<![CDATA[#[]#]]>
			</iterate>
		   ) 
	</select>
	
	
	<select id="queryPresellInfoByPresellId" parameterClass="java.lang.Long" resultMap="ibatorgenerated_BaseResultMap">
  			SELECT pp.PRESELL_ID,
		       pp.PRESELL_TITLE,
		       pp.SHOP_SORT,
		      'corporate_name' corporate_name,
		       pp.SUPPLIER_ID,
               pp.PRESELL_STATUS,
		       pp.AUDIT_STATUS,
		       pp.INITIAL_PRESELL_NUM,
		       pp.BUY_LIMIT,
		       pp.DEPOSIT_START_TIME,
		       pp.DEPOSIT_END_TIME,
		       pp.FINALPAY_START_TIME,
		       pp.FINALPAY_END_TIME,
		       pp.DELIVERY_START_TIME,
		       pp.DELIVERY_END_TIME,
		       pp.PRESELL_DESCRIBE,
		       pp.CREATE_TIME,
		       pp.MODIFY_TIME,
		       pp.CREATE_USER,
		       pp.MODIF_USER
		  FROM PROMOTION_PRESELL pp
  		  where pp.PRESELL_ID = #presellId:DECIMAL#
  </select>
	
</sqlMap>
