<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PROMOTION_RULE_DATA" >
  <resultMap id="ibatorgenerated_BaseResultMap" class="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    <result column="PROMOTION_RULE_DATA_ID" property="promotionRuleDataId" jdbcType="DECIMAL" />
    <result column="PROMOTION_ID" property="promotionId" jdbcType="DECIMAL" />
    <result column="MEET_DATA" property="meetData" jdbcType="DECIMAL" />
    <result column="MEET_DATA_TYPE" property="meetDataType" jdbcType="DECIMAL" />
    <result column="PRIZE_DATA" property="prizeData" jdbcType="VARCHAR" />
    <result column="PRIZE_DATA_TYPE" property="prizeDataType" jdbcType="DECIMAL" />
    <result column="entity_id" property="entityId" jdbcType="DECIMAL" />
    <result column="num1" property="num1" jdbcType="DECIMAL" />
    <result column="num2" property="num2" jdbcType="DECIMAL" />
    <result column="num3" property="num3" jdbcType="DECIMAL" />
  </resultMap>
  <sql id="ibatorgenerated_Example_Where_Clause" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    <iterate property="oredCriteria" conjunction="or" prepend="where" removeFirstPrepend="iterate" >
      <isEqual property="oredCriteria[].valid" compareValue="true" >
        (
        <iterate prepend="and" property="oredCriteria[].criteriaWithoutValue" conjunction="and" >
          $oredCriteria[].criteriaWithoutValue[]$
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithSingleValue" conjunction="and" >
          $oredCriteria[].criteriaWithSingleValue[].condition$
            #oredCriteria[].criteriaWithSingleValue[].value#
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithListValue" conjunction="and" >
          $oredCriteria[].criteriaWithListValue[].condition$
          <iterate property="oredCriteria[].criteriaWithListValue[].values" open="(" close=")" conjunction="," >
            #oredCriteria[].criteriaWithListValue[].values[]#
          </iterate>
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithBetweenValue" conjunction="and" >
          $oredCriteria[].criteriaWithBetweenValue[].condition$
          #oredCriteria[].criteriaWithBetweenValue[].values[0]# and
          #oredCriteria[].criteriaWithBetweenValue[].values[1]#
        </iterate>
        )
      </isEqual>
    </iterate>
  </sql>
  <select id="ibatorgenerated_selectByExample" resultMap="ibatorgenerated_BaseResultMap" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleDataExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    select PROMOTION_RULE_DATA_ID, PROMOTION_RULE_ID, MEET_DATA, MEET_DATA_TYPE, PRIZE_DATA,
      PRIZE_DATA_TYPE,'' as prizeName
    from PROMOTION_RULE_DATA d
    <isParameterPresent >
      <include refid="PROMOTION_RULE_DATA.ibatorgenerated_Example_Where_Clause" />
      <isNotNull property="orderByClause" >
        order by $orderByClause$
      </isNotNull>
    </isParameterPresent>
  </select>
  <select id="ibatorgenerated_selectByPrimaryKey" resultMap="ibatorgenerated_BaseResultMap" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    select PROMOTION_RULE_DATA_ID, PROMOTION_RULE_ID, MEET_DATA, MEET_DATA_TYPE, PRIZE_DATA,
      PRIZE_DATA_TYPE
    from PROMOTION_RULE_DATA
    where PROMOTION_RULE_DATA_ID = #promotionRuleDataId:DECIMAL#
  </select>
  <delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    delete from PROMOTION_RULE_DATA
    where PROMOTION_RULE_DATA_ID = #promotionRuleDataId:DECIMAL#
  </delete>
  <delete id="ibatorgenerated_deleteByExample" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleDataExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    delete from PROMOTION_RULE_DATA
    <include refid="PROMOTION_RULE_DATA.ibatorgenerated_Example_Where_Clause" />
  </delete>
  <insert id="ibatorgenerated_insert" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    <selectKey resultClass="java.lang.Long" keyProperty="promotionRuleDataId" >
    	select SEQ_APP_PROMOTION_RULE_DATA.nextval from dual
   	</selectKey>
    insert into PROMOTION_RULE_DATA (PROMOTION_RULE_DATA_ID, MEET_DATA,
      MEET_DATA_TYPE, PRIZE_DATA, PRIZE_DATA_TYPE)
    values (#promotionRuleDataId:DECIMAL# ,#meetData:DECIMAL#,
      #meetDataType:DECIMAL#, #prizeData:VARCHAR#, #prizeDataType:DECIMAL#)
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    <selectKey resultClass="java.lang.Long" keyProperty="promotionRuleDataId" >
    	select SEQ_APP_PROMOTION_RULE_DATA.nextval from dual
   	</selectKey>
    insert into PROMOTION_RULE_DATA
    <dynamic prepend="(" >
      <isNotNull prepend="," property="promotionRuleDataId" >
        PROMOTION_RULE_DATA_ID
      </isNotNull>
     
      <isNotNull prepend="," property="meetData" >
        MEET_DATA
      </isNotNull>
      <isNotNull prepend="," property="meetDataType" >
        MEET_DATA_TYPE
      </isNotNull>
      <isNotNull prepend="," property="prizeData" >
        PRIZE_DATA
      </isNotNull>
      <isNotNull prepend="," property="prizeDataType" >
        PRIZE_DATA_TYPE
      </isNotNull>
      <isNotNull prepend="," property="promotionId" >
        PROMOTION_ID
      </isNotNull>
      <isNotNull prepend="," property="num1" >
        NUM1
      </isNotNull>
      <isNotNull prepend="," property="entityId" >
        ENTITY_ID
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(" >
      <isNotNull prepend="," property="promotionRuleDataId" >
        #promotionRuleDataId:DECIMAL#
      </isNotNull>
     
      <isNotNull prepend="," property="meetData" >
        #meetData:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="meetDataType" >
        #meetDataType:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="prizeData" >
        #prizeData:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="prizeDataType" >
        #prizeDataType:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="promotionId" >
        #promotionId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="num1" >
        #num1:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="entityId" >
        #entityId:DECIMAL#
      </isNotNull>
     
     
      )
    </dynamic>
  </insert>
  <select id="ibatorgenerated_countByExample" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleDataExample" resultClass="java.lang.Integer" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    select count(*) from PROMOTION_RULE_DATA
    <include refid="PROMOTION_RULE_DATA.ibatorgenerated_Example_Where_Clause" />
  </select>
  <update id="ibatorgenerated_updateByExampleSelective" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    update PROMOTION_RULE_DATA
    <dynamic prepend="set" >
      <isNotNull prepend="," property="record.promotionRuleDataId" >
        PROMOTION_RULE_DATA_ID = #record.promotionRuleDataId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.meetData" >
        MEET_DATA = #record.meetData:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.meetDataType" >
        MEET_DATA_TYPE = #record.meetDataType:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.prizeData" >
        PRIZE_DATA = #record.prizeData:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.prizeDataType" >
        PRIZE_DATA_TYPE = #record.prizeDataType:DECIMAL#
      </isNotNull>
    </dynamic>
    <isParameterPresent >
      <include refid="PROMOTION_RULE_DATA.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    update PROMOTION_RULE_DATA
    set PROMOTION_RULE_DATA_ID = #record.promotionRuleDataId:DECIMAL#,
      MEET_DATA = #record.meetData:DECIMAL#,
      MEET_DATA_TYPE = #record.meetDataType:DECIMAL#,
      PRIZE_DATA = #record.prizeData:VARCHAR#,
      PRIZE_DATA_TYPE = #record.prizeDataType:DECIMAL#
    <isParameterPresent >
      <include refid="PROMOTION_RULE_DATA.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByPrimaryKeySelective" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    update PROMOTION_RULE_DATA
    <dynamic prepend="set" >
      <isNotNull prepend="," property="meetData" >
        MEET_DATA = #meetData:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="meetDataType" >
        MEET_DATA_TYPE = #meetDataType:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="prizeData" >
        PRIZE_DATA = #prizeData:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="prizeDataType" >
        PRIZE_DATA_TYPE = #prizeDataType:DECIMAL#
      </isNotNull>
    </dynamic>
    where PROMOTION_RULE_DATA_ID = #promotionRuleDataId:DECIMAL#
  </update>
  <update id="ibatorgenerated_updateByPrimaryKey" parameterClass="com.kmzyc.promotion.app.vobject.PromotionRuleData" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Mon Sep 23 11:05:55 CST 2013.
    -->
    update PROMOTION_RULE_DATA
    set 
      MEET_DATA = #meetData:DECIMAL#,
      MEET_DATA_TYPE = #meetDataType:DECIMAL#,
      PRIZE_DATA = #prizeData:VARCHAR#,
      PRIZE_DATA_TYPE = #prizeDataType:DECIMAL#
    where PROMOTION_RULE_DATA_ID = #promotionRuleDataId:DECIMAL#
  </update>
  <select id="findByPromotionRuleDataInfo" parameterClass="java.lang.Long" resultMap="ibatorgenerated_BaseResultMap">
  	<![CDATA[
  	select PROMOTION_RULE_DATA_ID,MEET_DATA, MEET_DATA_TYPE, 
  	PRIZE_DATA,PRIZE_DATA_TYPE,d.entity_id,d.num1,d.num2,d.num3,d.promotion_id
    from PROMOTION_RULE_DATA d
    where d.promotion_id = #pId:DECIMAL# 
	order by MEET_DATA asc
	]]>
  </select>
  
  <insert id="copyPromotionRuleData" parameterClass="java.util.HashMap" >
  insert into promotion_rule_data (promotion_rule_data_id,promotion_rule_id ,meet_data,meet_data_type,prize_data,prize_data_type,entity_id,num1,
  num2,num3,promotion_id) select  SEQ_APP_PROMOTION_RULE_DATA.nextval,promotion_rule_id ,meet_data,meet_data_type,prize_data,prize_data_type,entity_id,num1,
  num2,num3,#newPromotionId:DECIMAL#  from promotion_rule_data ,dual d where promotion_id = #oldPromotionId:DECIMAL#
  </insert>
  	
  	<!-- 批量查询规则数据 -->
	<select id="SQL_QUERY_BATCH_PROMOTION_RULE_DATA" parameterClass="java.util.List" resultClass="com.kmzyc.promotion.app.vobject.PromotionRuleData">
	<![CDATA[
		select prd.promotion_rule_data_id promotionRuleDataId,
		       prd.meet_data              meetData,
		       prd.meet_data_type         meetDataType,
		       prd.prize_data             prizeData,
		       prd.prize_data_type        prizeDataType,
		       prd.entity_id              entityId,
		       prd.num1                   num1,
		       prd.num2                   num2,
		       prd.num3                   num3,
		       prd.promotion_id           promotionId
		  from promotion_rule_data prd
		 where prd.promotion_id in
	]]>
		<iterate open="(" close=")" conjunction=",">
		   		#[]#
		</iterate>
		order by prd.promotion_id, prd.meet_data desc
	</select>
	
	
	
	<select id="selectPromotionRuleAndProductEntity" parameterClass="java.util.Map" resultClass="com.alibaba.fastjson.JSONObject">
  	select PROMOTION_RULE_DATA_ID,
       MEET_DATA,
       MEET_DATA_TYPE,
       PRIZE_DATA,
       d.entity_id,
       d.num1,
       d.promotion_id,
       (SELECT 
             wmsys.wm_concat(vsa.category_attr_value) 
        FROM (
               SELECT 
                  NVL(d.category_attr_value,c.new_attr) category_attr_value,c.product_sku_id 
               FROM product_sku_attr c
               LEFT JOIN category_attr_value d ON c.category_attr_value_id = d.category_attr_value_id
               ) vsa
        where vsa.product_sku_id = d.entity_id) skuAttr,         
       pm.product_title as procuct_name,
       i.img_path
  from PROMOTION_RULE_DATA d
  join product_sku sku
    on sku.product_sku_id = d.entity_id
  join productmain pm
    on pm.product_id = sku.product_id
  left join product_image i
    on (i.sku_id = sku.product_sku_id and i.is_default = 0)
 where d.promotion_id = #promotionId#
 order by MEET_DATA asc
  </select>
  
  <select id="selectPromotionRuleAndCouponEntity" parameterClass="java.util.Map" resultClass="com.alibaba.fastjson.JSONObject">
  	  select PROMOTION_RULE_DATA_ID,
         MEET_DATA,
         MEET_DATA_TYPE,
         PRIZE_DATA,
         d.entity_id,
         d.num1,
         d.promotion_id,
         c.COUPON_NAME,
         c.coupon_money
    from PROMOTION_RULE_DATA d
    join coupon c
      on c.coupon_id = d.entity_id
   where d.promotion_id = #promotionId#
   order by MEET_DATA asc
	</select>
	
	<select id="selectPromotionRuleData" parameterClass="java.util.Map" resultClass="com.alibaba.fastjson.JSONObject">
  	  select PROMOTION_RULE_DATA_ID,
         MEET_DATA,
         MEET_DATA_TYPE,
         PRIZE_DATA,
         d.entity_id,
         d.num1,
         d.promotion_id
    from PROMOTION_RULE_DATA d
   where d.promotion_id = #promotionId#
   order by MEET_DATA asc
	</select>
	
	<select id="queryGantProduct" parameterClass="java.util.Map" resultClass="com.alibaba.fastjson.JSONObject">	  	
	  	SELECT 
          b.PRARENT_SKU_ID prarentSkuId,
          b.PROMOTION_PRODUCT_ID promotionProductId,
          b.PROMOTION_ID promotionId, 
          b.PRODUCT_SKU_ID productSkuId,
          b.NUM num,
          i.IMG_PATH imagePath,
          pm.product_title productTitle,
          (SELECT 
                wmsys.wm_concat(vsa.category_attr_value) 
           FROM (
                  SELECT 
                     NVL(d.category_attr_value,c.new_attr) category_attr_value,c.product_sku_id 
                  FROM product_sku_attr c
                  LEFT JOIN category_attr_value d ON c.category_attr_value_id = d.category_attr_value_id
                  ) vsa
           where vsa.product_sku_id = b.product_sku_id) skuAttrValue  
        from PROMOTION a  
	      	INNER JOIN PROMOTION_PRODUCT_DATA b ON a.PROMOTION_ID=b.PROMOTION_ID      
	      	INNER JOIN PRODUCT_SKU sku ON sku.product_sku_id=b.product_sku_id
		    INNER JOIN PRODUCTMAIN pm ON pm.product_id=sku.product_id
		    LEFT JOIN PRODUCT_IMAGE i ON (i.SKU_ID = sku.PRODUCT_SKU_ID AND i.IS_DEFAULT = 0)
      
      		<isNotEmpty property="productSkuId">  
      			INNER JOIN promotion_product c ON b.PROMOTION_PRODUCT_ID = c.PROMOTION_PRODUCT_ID AND c.status=2
      		</isNotEmpty>
      
  		WHERE a.PROMOTION_ID =#promotionId# 
  		<isNotEmpty property="productSkuId">  			
  			AND b.PRARENT_SKU_ID = #productSkuId#
  		</isNotEmpty>
  </select>
	
</sqlMap>